(()=>{function C({title:e,folders:t,showViews:o=!1,targetId:n,onRefresh:r=null}){let a=document.createElement("section");a.className="folder-section slider";let c=document.createElement("div");c.className="folder-section-header";let i=document.createElement("div");i.className="slider-left";let s=document.createElement("h3");s.className="folder-section-title",s.textContent=e,i.appendChild(s),c.appendChild(i);let l=e.toLowerCase().includes("v\u1EEBa xem")||e.toLowerCase().includes("v\u1EEBa nghe")||e.toLowerCase().includes("m\u1EDBi \u0111\u1ECDc")||e.toLowerCase().includes("nh\u1EA1c v\u1EEBa nghe");if(e.includes("ng\u1EABu nhi\xEAn")||l){let h=document.createElement("div");if(h.className="slider-right",e.includes("ng\u1EABu nhi\xEAn")){let u=document.createElement("button");u.id="refresh-random-btn",u.textContent="\u{1F504} Refresh",u.className="small-button",h.appendChild(u),u.onclick=()=>{typeof r=="function"&&r()};let g=document.createElement("span");g.className="random-timestamp",e.includes("Folder")?g.id="random-timestamp-folder":e.includes("Video")?g.id="random-timestamp-video":e.includes("B\xE0i h\xE1t")?g.id="random-timestamp-audio":g.id="random-timestamp",g.textContent="",h.appendChild(g)}if(l){let u=document.createElement("button");u.textContent="\u{1F5D1}\uFE0F Xo\xE1 t\u1EA5t c\u1EA3",u.className="small-button",u.onclick=()=>{let g,y;window.location.pathname.includes("movie")?(g=U(),y=O):window.location.pathname.includes("music")?(g=ne(),y=window.renderRecentViewedMusic||O):(g=oe(),y=O),localStorage.removeItem(g),y([])},h.appendChild(u)}c.appendChild(h)}a.appendChild(c);let d=document.createElement("div");d.style.position="relative";let m=document.createElement("div");m.className="slider-wrapper",m.style.scrollSnapType="x mandatory",m.style.overflowX="auto";let b=window.location.pathname.includes("movie");t.forEach(h=>{let u=window.location.pathname.includes("music"),g=window.location.pathname.includes("movie"),y=!u&&!g,j="movie";u?j="music":y&&(j="manga");let ye=X(h,j),ve={...h,thumbnail:ye},H=q(ve,o);H.style.scrollSnapAlign="start",m.appendChild(H);let D=encodeURIComponent(h.path),J=p();H.onclick=we=>{if(we.target.classList.contains("folder-fav"))return;if(h.isPlaylist){let W=p();window.location.href=`/music/player.html?playlist=${encodeURIComponent(h.path)}&key=${W}`;return}let A=window.location.pathname.includes("music"),Z=window.location.pathname.includes("movie");if(A&&(h.type==="audio"||h.type==="file")||Z&&(h.type==="video"||h.type==="file")){let W=A?"music/player":"movie/player";window.location.href=`/${W}.html?file=${D}&key=${J}`;return}A?window.location.href=`/music/index.html?path=${D}&key=${J}`:Z?window.location.href=`/movie/index.html?path=${D}&key=${J}`:h.isSelfReader&&h.images?window.location.href=`/manga/reader.html?path=${D}`:typeof window.loadFolder=="function"&&window.loadFolder(h.path)}}),d.appendChild(m);let k=window.innerWidth<=768,M=document.createElement("button"),T=document.createElement("button");M.className="nav-button prev-button",T.className="nav-button next-button",M.innerHTML="\u2190",T.innerHTML="\u2192",k||(d.appendChild(M),d.appendChild(T)),a.appendChild(d);let F=document.createElement("div");F.className="slider-pagination",a.appendChild(F);let V=n?document.getElementById(n):document.getElementById(e.includes("ng\u1EABu nhi\xEAn")?"section-random":e.includes("Xem nhi\u1EC1u")?"section-topview":"section-recent");V&&(V.innerHTML="",V.appendChild(a));let N=m.querySelector(".folder-card")?.offsetWidth+16||200,Q=Math.ceil(t.length/5);M.onclick=()=>m.scrollBy({left:-N,behavior:"smooth"}),T.onclick=()=>m.scrollBy({left:N,behavior:"smooth"});for(let h=0;h<Q;h++){let u=document.createElement("span");u.className="pagination-dot",u.style.cursor="pointer",h===0&&u.classList.add("active"),u.onclick=()=>m.scrollTo({left:h*N*5,behavior:"smooth"}),F.appendChild(u)}m.addEventListener("scroll",()=>{let h=m.scrollLeft/(m.scrollWidth-m.clientWidth),u=Math.round(h*(Q-1));F.querySelectorAll(".pagination-dot").forEach((g,y)=>{g.classList.toggle("active",y===u)})});let R=0,L=null,ge=()=>{let h=m.scrollWidth-m.clientWidth;R+=N*5,R>h&&(R=0),m.scrollTo({left:R,behavior:"smooth"})},G=()=>{!k&&!L&&(L=setInterval(ge,2e4))},Y=()=>{L&&clearInterval(L),L=null};new IntersectionObserver(h=>{h[0].isIntersecting?G():Y()},{threshold:.5}).observe(a),m.addEventListener("mouseenter",Y),m.addEventListener("mouseleave",G)}function ee(){["randomFolderSection","randomVideoSection"].forEach(e=>{if(!document.getElementById(e)){let t=document.createElement("section");t.id=e,document.body.prepend(t)}})}function te(e="movie"){let t=p(),o=e==="music",n=o?"/api/music/audio-cache":"/api/movie/video-cache";P("folder",t,"randomFolderSection",o?"\u{1F3B2} Th\u01B0 m\u1EE5c nh\u1EA1c ng\u1EABu nhi\xEAn":"\u{1F3B2} Folder ng\u1EABu nhi\xEAn",!1,n,"random-timestamp-folder"),P("file",t,o?"randomAudioSection":"randomVideoSection",o?"\u{1F3B5} B\xE0i h\xE1t ng\u1EABu nhi\xEAn":"\u{1F3AC} Video ng\u1EABu nhi\xEAn",!1,n,o?"random-timestamp-audio":"random-timestamp-video")}async function P(e,t,o,n,r=!1,a,c){if(!a){let s=window.location.pathname;s.includes("music")?a="/api/music/audio-cache":s.includes("movie")?a="/api/movie/video-cache":s.includes("manga")||s.includes("comic")||s.includes("reader")?a="/api/manga/folder-cache":a="/api/movie/video-cache"}if(!t)return;let i=`${e==="file"?a.includes("music")?"randomAudios":"randomVideos":"randomFolders"}-${t}`;if(c=c||(e==="file"?a.includes("music")?"random-timestamp-audio":"random-timestamp-video":"random-timestamp-folder"),!r){let s=localStorage.getItem(i);if(s)try{let l=JSON.parse(s);if(!(Date.now()-l.timestamp>30*60*1e3)){C({title:n,folders:l.data,targetId:o,onRefresh:()=>P(e,t,o,n,!0,a,c)}),document.getElementById(c)&&_(l.timestamp,c);return}}catch{}}try{let l=await(await fetch(`${a}?mode=random&type=${e}&key=${t}`)).json(),d=Array.isArray(l)?l:l.folders,m=Date.now();localStorage.setItem(i,JSON.stringify({data:d,timestamp:m})),C({title:n,folders:d,targetId:o,onRefresh:()=>P(e,t,o,n,!0,a,c)}),document.getElementById(c)&&_(m,c)}catch(s){console.error("\u274C L\u1ED7i random slider:",s)}}async function Ce(){let e=document.getElementById("floatingSearchInput")?.value.trim().toLowerCase(),t=document.getElementById("search-dropdown"),o=w(),n=p();if(!e){t.classList.add("hidden"),t.innerHTML="";return}t.classList.remove("hidden"),t.innerHTML='<div id="search-loader">\u{1F50D} \u0110ang t\xECm ki\u1EBFm...</div>';try{let a=await(await fetch(`/api/manga/folder-cache?mode=search&key=${encodeURIComponent(n)}&root=${encodeURIComponent(o)}&q=${encodeURIComponent(e)}`)).json();if(t.innerHTML="",a.length===0){t.innerHTML='<div id="search-loader">\u274C Kh\xF4ng t\xECm th\u1EA5y k\u1EBFt qu\u1EA3</div>';return}a.forEach(c=>{let i=document.createElement("div");i.className="search-item",i.innerHTML=`
        <img src="${c.thumbnail}" class="search-thumb" alt="thumb">
        <div class="search-title">${c.name}</div>
      `,i.onclick=()=>{t.classList.add("hidden"),window.location.pathname.includes("reader.html")?window.location.href=`/manga/index.html?path=${encodeURIComponent(c.path)}`:window.loadFolder?.(c.path)},t.appendChild(i)})}catch(r){t.innerHTML='<div id="search-loader">\u26A0\uFE0F L\u1ED7i khi t\xECm ki\u1EBFm</div>',console.error("\u274C L\u1ED7i t\xECm ki\u1EBFm:",r)}}async function ae(){let e=document.getElementById("floatingSearchInput")?.value.trim().toLowerCase(),t=document.getElementById("search-dropdown"),o=localStorage.getItem("sourceKey"),n=document.getElementById("search-type-select")?.value||"video";if(!e){t.classList.add("hidden"),t.innerHTML="";return}t.classList.remove("hidden"),t.innerHTML='<div id="search-loader">\u{1F50D} \u0110ang t\xECm video...</div>';try{let a=await(await fetch(`/api/movie/video-cache?mode=search&key=${encodeURIComponent(o)}&q=${encodeURIComponent(e)}&type=${encodeURIComponent(n)}`)).json();if(t.innerHTML="",!a.folders||a.folders.length===0){t.innerHTML='<div id="search-loader">\u274C Kh\xF4ng t\xECm th\u1EA5y video n\xE0o</div>';return}a.folders.forEach(c=>{let i=document.createElement("div");i.className="search-item";let s=X(c,"movie");i.innerHTML=`
    <img src="${s}" class="search-thumb" alt="thumb">
    <div class="search-title">${c.name}</div>
  `,i.onclick=()=>{t.classList.add("hidden"),c.type==="video"||c.type==="file"?window.location.href=`/movie/player.html?file=${encodeURIComponent(c.path)}&key=${o}`:window.location.href=`/movie/index.html?path=${encodeURIComponent(c.path)}`},t.appendChild(i)})}catch(r){console.error("\u274C L\u1ED7i t\xECm ki\u1EBFm video:",r),t.innerHTML='<div id="search-loader">\u26A0\uFE0F L\u1ED7i khi t\xECm ki\u1EBFm</div>'}}function ie(){let e=document.getElementById("floating-search");e?.classList.toggle("active");let t=document.getElementById("floatingSearchInput");e?.classList.contains("active")?t?.focus():(t.value="",Ce())}function _(e,t="random-timestamp"){let o=document.getElementById(t);if(!o)return;let n=Math.floor((Date.now()-e)/6e4);window.innerWidth<=480?o.textContent=`\u{1F3B2} ${n===0?"now":`${n}m`}`:o.textContent=`\u{1F3B2} Random ${n===0?"v\u1EEBa xong":`${n} ph\xFAt tr\u01B0\u1EDBc`}`}function O(e=[]){let t=window.location.pathname.includes("movie"),o=t?e.filter(n=>n.type==="video"||n.type==="file"):e.filter(n=>!n.type||n.type!=="video"&&n.type!=="file");C({title:t?"\u{1F553} V\u1EEBa xem":"\u{1F558} M\u1EDBi \u0111\u1ECDc",folders:o,targetId:"section-recent"})}function B(e,t){let o=document.createElement("button");return o.textContent=e,o.onclick=t,o}function re(){let e=document.getElementById("sidebar-menu");e&&e.classList.toggle("active")}function x(e){return async(...t)=>{let o=document.getElementById("loading-overlay");o?.classList.remove("hidden"),await new Promise(n=>requestAnimationFrame(()=>setTimeout(n,0)));try{await e(...t)}catch(n){console.error("\u274C withLoading error:",n)}finally{o?.classList.add("hidden")}}}function f(e){let t=document.getElementById("global-toast");t||(t=document.createElement("div"),t.id="global-toast",t.style.position="fixed",t.style.bottom="20px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.background="#333",t.style.color="white",t.style.padding="10px 20px",t.style.borderRadius="8px",t.style.zIndex="9999",t.style.fontSize="14px",document.body.appendChild(t)),t.textContent=e,t.style.display="block",setTimeout(()=>{t.style.display="none"},3e3)}function I(e,t={}){let o=document.getElementById("global-confirm");return o||(o=document.createElement("div"),o.id="global-confirm",o.className="modal-overlay hidden",o.innerHTML=`
      <div class="modal-box">
        <p id="confirm-text"></p>
        <div class="buttons">
          <button class="ok">OK</button>
          <button class="cancel">Hu\u1EF7</button>
        </div>
      </div>
    `,document.body.appendChild(o)),o.querySelector("#confirm-text").textContent=e,o.classList.remove("hidden"),new Promise(n=>{let r=o.querySelector("button.ok"),a=o.querySelector("button.cancel"),c=()=>{o.classList.add("hidden"),r.removeEventListener("click",i),a.removeEventListener("click",s)},i=()=>{c(),t.loading&&document.getElementById("loading-overlay")?.classList.remove("hidden"),n(!0)},s=()=>{c(),n(!1)};r.addEventListener("click",i),a.addEventListener("click",s)})}function ce(){let e=document.getElementById("sidebar-menu");if(!e)return;e.innerHTML="";let t=p();e.appendChild(B("\u{1F3AC} \u0110\u1ED5i Movie Folder",()=>{localStorage.removeItem("rootFolder"),window.location.href="/home.html"})),e.appendChild(B("\u{1F5D1} Xo\xE1 DB Movie",x(async()=>{if(await I("B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n xo\xE1 to\xE0n b\u1ED9 DB Movie?"))try{let r=await(await fetch(`/api/movie/reset-cache-movie?key=${t}&mode=delete`,{method:"DELETE"})).json();f(r.message||"\u2705 \u0110\xE3 xo\xE1 DB Movie"),window.location.reload()}catch(n){f("\u274C L\u1ED7i khi g\u1ECDi API xo\xE1 DB Movie"),console.error(n)}}))),e.appendChild(B("\u{1F5D1} Reset DB Movie (xo\u0301a va\u0300 scan)",x(async()=>{if(await I("B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n xo\xE1 to\xE0n b\u1ED9 DB Movie?",{loading:!0}))try{let r=await(await fetch(`/api/movie/reset-cache-movie?key=${t}&mode=reset`,{method:"DELETE"})).json();f(r.message||"\u2705 \u0110\xE3 xo\xE1 DB Movie"),window.location.reload()}catch(n){f("\u274C L\u1ED7i khi g\u1ECDi API xo\xE1 DB Movie"),console.error(n)}}))),e.appendChild(B("\u{1F4E6} Qu\xE9t th\u01B0 m\u1EE5c m\u1EDBi",x(async()=>{if(await I("Qu\xE9t folder m\u1EDBi (kh\xF4ng xo\xE1 DB)?",{}))try{let r=await(await fetch("/api/movie/scan-movie",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:t})})).json();f(`\u2705 Scan xong:
Inserted ${r.stats.inserted}, Updated ${r.stats.updated}, Skipped ${r.stats.skipped}`)}catch(n){f("\u274C L\u1ED7i khi qu\xE9t folder"),console.error(n)}}))),e.appendChild(B("\u{1F9FC} Xo\xE1 cache folder",x(async()=>{if(!await I("B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n xo\xE1 cache folder movie localStorage?"))return;let n=0;Object.keys(localStorage).forEach(r=>{r.startsWith(`movieCache::${t}::`)&&(localStorage.removeItem(r),n++)}),f(`\u2705 \u0110\xE3 xo\xE1 ${n} cache folder`)})))}function X(e,t="movie"){let o="/video/",n="/default/video-thumb.png",r="/default/folder-thumb.png";t==="music"?(o="/audio/",n="/default/music-thumb.png",r="/default/folder-thumb.png"):(t==="manga"||t==="comic")&&(o="/manga/",n="/default/manga-thumb.png",r="/default/folder-thumb.png");let a;return e.type==="folder"?a=e.path||"":a=e.path?.split("/").slice(0,-1).join("/")||"",e.thumbnail?e.thumbnail.startsWith(o)||e.thumbnail.startsWith("http")||e.thumbnail.startsWith("/default/")?e.thumbnail:(a&&e.thumbnail.startsWith(a+"/")&&(e.thumbnail=e.thumbnail.slice(a.length+1)),`${o}${a?a+"/":""}${e.thumbnail.replace(/\\/g,"/")}`):t==="music"?e.type==="audio"||e.type==="file"?n:r:t==="manga"||t==="comic"?e.type==="folder"?r:n:e.type==="video"||e.type==="file"?n:r}var z="movieCache::";function w(){return localStorage.getItem("rootFolder")}function p(){return localStorage.getItem("sourceKey")}function se(e,t){return e?`${z}${e}::${t||""}`:null}function oe(){return`recentViewed::${w()}::${w()}`}function le(e,t){let o=se(e,t),n=localStorage.getItem(o);if(!n)return null;try{let r=JSON.parse(n);return{data:r.data,timestamp:r.timestamp}}catch{return localStorage.removeItem(o),null}}function de(e,t,o){if(!e){let i=`\u26A0\uFE0F Kh\xF4ng cache \u0111\u01B0\u1EE3c do thi\u1EBFu th\xF4ng tin: sourceKey = ${e}`;console.warn(i),f(i);return}if(!o||Array.isArray(o)&&o.length===0){console.warn("\u26A0\uFE0F Movie data r\u1ED7ng, kh\xF4ng l\u01B0u cache:",t);return}let n=se(e,t),r=JSON.stringify({timestamp:Date.now(),data:o}),a=4*1024*1024+300,c=Se();if(r.length>a){let i=`\u26A0\uFE0F Movie folder qu\xE1 l\u1EDBn, kh\xF4ng cache localStorage: ${t}`;console.warn(i),f(i);return}if(c+r.length>a){let i=a-r.length;i>a/2&&(i=a/2),be(i)}localStorage.setItem(n,r)}function Se(){let e=0;for(let t in localStorage)if(t.startsWith(z)){let o=localStorage.getItem(t);e+=o?.length||0}return e}function be(e){let t=[];for(let n in localStorage)if(n.startsWith(z))try{let r=localStorage.getItem(n),a=JSON.parse(r);t.push({key:n,size:r.length,timestamp:a.timestamp||0})}catch{localStorage.removeItem(n)}t.sort((n,r)=>n.timestamp-r.timestamp);let o=0;for(let n of t)if(localStorage.removeItem(n.key),o+=n.size,o>=e)break;console.log(`\u{1F9F9} D\u1ECDn movie cache: \u0111\xE3 xo\xE1 ${o} byte`)}function U(){return`recentViewedVideo::${p()}`}function ne(){return`recentViewedMusic::${p()}`}function q(e,t=!1){let o=document.createElement("div");o.className="folder-card";let n=e.thumbnail?`<img src="${e.thumbnail}" alt="${e.name}" loading="lazy">`:'<div class="folder-thumb-placeholder">Kh\xF4ng c\xF3 \u1EA3nh</div>',r=e.name;e.name==="__self__"&&(r=e.path.split("/").at(-2)||"\u1EA2nh"),o.innerHTML=`
    <div class="folder-thumb">
      ${n}
      ${t&&e.count?`<div class="folder-views">\u{1F441} ${e.count}</div>`:""}
      <div class="folder-fav ${e.isFavorite?"active":""}" title="${e.isFavorite?"B\u1ECF y\xEAu th\xEDch":"Th\xEAm y\xEAu th\xEDch"}">${e.isFavorite?"\u2764\uFE0F":"\u{1F90D}"}</div>
    </div>
    <div class="folder-title">${r}</div>
  `,o.onclick=c=>{if(!c.target.classList.contains("folder-fav"))if(e.isSelfReader&&e.images){let i=encodeURIComponent(e.path);window.location.href=`/manga/reader.html?path=${i}`}else window.loadFolder?.(e.path)};let a=o.querySelector(".folder-fav");return a.onclick=async c=>{c.stopPropagation();let i=p(),s=w(),l=!e.isFavorite;e.isFavorite=l,a.classList.toggle("active",l),a.textContent=l?"\u2764\uFE0F":"\u{1F90D}",a.title=l?"B\u1ECF y\xEAu th\xEDch":"Th\xEAm y\xEAu th\xEDch";try{let d=i?.startsWith("V_");await fetch(d?"/api/movie/favorite-movie":"/api/manga/favorite",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dbkey:i,path:e.path,value:l})}),ke(i,s,e.path,l)}catch(d){console.warn("\u274C Kh\xF4ng th\u1EC3 l\u01B0u y\xEAu th\xEDch:",d)}},o}function ke(e,t,o,n){if(e?.startsWith("V_")){let c=`movieCache::${e}::`;for(let i in localStorage)if(i.startsWith(c))try{let s=localStorage.getItem(i),l=JSON.parse(s),d=!1;if(Array.isArray(l.data))for(let m of l.data)m.path===o&&(m.isFavorite=n,d=!0);d&&localStorage.setItem(i,JSON.stringify(l))}catch(s){console.warn("\u274C Kh\xF4ng th\u1EC3 update movieCache:",s)}["randomFolders","randomVideos"].forEach(i=>{let s=`${i}-${e}`,l=localStorage.getItem(s);if(l)try{let d=JSON.parse(l),m=!1;if(Array.isArray(d.data))for(let b of d.data)b.path===o&&(b.isFavorite=n,m=!0);m&&localStorage.setItem(s,JSON.stringify(d))}catch(d){console.warn("\u274C Kh\xF4ng th\u1EC3 update random cache:",d)}});return}let a=`folderCache::${e}::${t}`;for(let c in localStorage)if(c.startsWith(a))try{let i=localStorage.getItem(c),s=JSON.parse(i),l=!1;if(s.data&&s.data.folders)for(let d of s.data.folders)d.path===o&&(d.isFavorite=n,l=!0);s.data?.images&&o.endsWith("/__self__")&&(s.data.isFavorite=n,l=!0),l&&localStorage.setItem(c,JSON.stringify(s))}catch(i){console.warn("\u274C Kh\xF4ng th\u1EC3 update folderCache:",i)}try{let c=`recentViewed::${t}::${t}`,i=localStorage.getItem(c);if(i){let s=JSON.parse(i),l=!1;for(let d of s)d.path===o&&(d.isFavorite=n,l=!0);l&&localStorage.setItem(c,JSON.stringify(s))}}catch(c){console.warn("\u274C Kh\xF4ng th\u1EC3 update recentViewed:",c)}}function me(e){let t=document.createElement("div");t.className="movie-card";let o=e.thumbnail;(!o||o==="null")&&(o=e.type==="folder"?"/default/folder-thumb.png":"/default/video-thumb.png");let n=document.createElement("img");n.className="movie-thumb",n.src=o;let r=document.createElement("div");r.className="movie-info";let a=document.createElement("div");a.className="movie-title",a.textContent=e.name,t.title=e.name;let c=document.createElement("div");c.className="movie-sub",c.textContent=e.type==="video"?"\u{1F3AC} Video file":"\u{1F4C1} Th\u01B0 m\u1EE5c",r.appendChild(a),r.appendChild(c),t.appendChild(n),t.appendChild(r);let i=document.createElement("div");return i.className="folder-fav"+(e.isFavorite?" active":""),i.title=e.isFavorite?"B\u1ECF y\xEAu th\xEDch":"Th\xEAm y\xEAu th\xEDch",i.textContent=e.isFavorite?"\u2764\uFE0F":"\u{1F90D}",i.onclick=async s=>{s.stopPropagation();let l=!e.isFavorite;e.isFavorite=l,i.classList.toggle("active",l),i.textContent=l?"\u2764\uFE0F":"\u{1F90D}",i.title=l?"B\u1ECF y\xEAu th\xEDch":"Th\xEAm y\xEAu th\xEDch";try{await fetch("/api/movie/favorite-movie",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dbkey:p(),path:e.path,value:l})})}catch(d){console.warn("\u274C L\u1ED7i khi toggle favorite:",d)}},t.appendChild(i),t.onclick=()=>{let s=encodeURIComponent(e.path),l=p();e.type==="video"||e.type==="file"?window.location.href=`/movie/player.html?file=${s}&key=${l}`:window.location.href=`/movie/index.html?path=${s}`},t}function he(){document.addEventListener("click",e=>{let t=document.getElementById("sidebar-menu"),o=document.getElementById("sidebarToggle"),n=t?.contains(e.target),r=o?.contains(e.target);t?.classList.contains("active")&&!n&&!r&&t.classList.remove("active");let a=document.getElementById("search-dropdown"),c=document.getElementById("floatingSearchInput");a&&c&&(a.contains(e.target)||c.contains(e.target)||a.classList.add("hidden"))})}window.addEventListener("DOMContentLoaded",()=>{let e=xe();$(e),Ie(),ee(),te(),Ee(),ce(),$e(),document.getElementById("floatingSearchInput")?.addEventListener("input",ae),document.getElementById("searchToggle")?.addEventListener("click",ie),document.getElementById("sidebarToggle")?.addEventListener("click",re),he()});function xe(){return new URLSearchParams(window.location.search).get("path")||""}function Ie(){let e=document.getElementById("extract-thumbnail-btn");e&&(e.onclick=x(async()=>{if(!await I("Extract l\u1EA1i thumbnail phim cho to\xE0n b\u1ED9 folder hi\u1EC7n t\u1EA1i?"))return;let o=p();if(!o){f("\u274C Kh\xF4ng x\xE1c \u0111\u1ECBnh \u0111\u01B0\u1EE3c ngu\u1ED3n phim!");return}try{(await(await fetch("/api/movie/extract-thumbnail",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:o,path:v})})).json()).success?(f("\u2705 \u0110\xE3 extract thumbnail xong!"),$(v,E)):f("\u274C L\u1ED7i extract thumbnail!")}catch(n){f("\u274C L\u1ED7i khi extract thumbnail!"),console.error(n)}}))}var E=0,K=20,S=[],v="";function ue(e){return e.slice(E*K,(E+1)*K)}function $(e="",t=0){let o=p();if(!o){alert("Ch\u01B0a ch\u1ECDn ngu\u1ED3n phim!"),window.location.href="/home.html";return}v=e,E=t;let n=le(o,e);if(n&&Date.now()-n.timestamp<7*60*60*1e3){console.log("\u26A1 D\xF9ng cache movie folder:",e),S=n.data||[],pe(ue(S),e),fe(E,S.length,K);return}let r=new URLSearchParams;r.set("key",o),e&&r.set("path",e),fetch("/api/movie/movie-folder?"+r.toString()).then(a=>a.json()).then(a=>{S=a.folders||[],de(o,e,S),pe(ue(S),e),fe(E,S.length,K)}).catch(a=>{console.error("\u274C Failed to load movie folder:",a),f("\u{1F6AB} L\u1ED7i t\u1EA3i th\u01B0 m\u1EE5c phim!")})}function pe(e){let t=document.getElementById("movie-app");t.innerHTML="";let o=v?v.split("/").filter(Boolean):[],n=document.createElement("h2");if(n.className="folder-section-title",o.length===0)n.textContent="\u{1F4C2} Danh s\xE1ch phim";else{let a=o[o.length-1];n.textContent="\u{1F4C1} "+a,n.title=a,n.style.cursor="pointer",n.onclick=()=>{let c=o.slice(0,-1).join("/");$(c)}}t.appendChild(n);let r=document.createElement("div");r.className="movie-grid",e.forEach(a=>{let c=a.path?.split("/").filter(Boolean);(a.type==="video"||a.type==="file")&&c.pop();let i=c.join("/"),s=a.thumbnail?`/video/${i?i+"/":""}${a.thumbnail.replace(/\\/g,"/")}`:a.type==="video"||a.type==="file"?"/default/video-thumb.png":"/default/folder-thumb.png",l=me({name:a.name,path:a.path,thumbnail:s,type:a.type,isFavorite:a.isFavorite??!1});r.appendChild(l)}),t.appendChild(r)}function Ee(){let e=p();e&&fetch(`/api/movie/video-cache?key=${e}&mode=top`).then(t=>t.json()).then(t=>{C({title:"\u{1F525} Xem nhi\u1EC1u",folders:t.folders,showViews:!0})})}function fe(e,t,o){let n=Math.ceil(t/o),r=document.getElementById("movie-app"),a=document.createElement("div");a.className="reader-controls";let c=document.createElement("button");c.textContent="\u2B05 Trang tr\u01B0\u1EDBc",c.disabled=e<=0,c.onclick=()=>$(v,e-1),a.appendChild(c);let i=document.createElement("form");i.style.display="inline-block",i.style.margin="0 10px",i.onsubmit=b=>{b.preventDefault();let k=parseInt(s.value)-1;!isNaN(k)&&k>=0&&$(v,k)};let s=document.createElement("input");s.type="number",s.min=1,s.max=n,s.placeholder="Trang...",s.style.width="60px";let l=document.createElement("button");l.textContent="\u23E9",i.appendChild(s),i.appendChild(l),a.appendChild(i);let d=document.createElement("button");d.textContent="Trang sau \u27A1",d.disabled=e+1>=n,d.onclick=()=>$(v,e+1),a.appendChild(d),r.appendChild(a);let m=document.createElement("div");m.textContent=`Trang ${e+1} / ${n}`,m.style.textAlign="center",m.style.marginTop="10px",r.appendChild(m)}function $e(){let e=localStorage.getItem(U());if(!e)return;let o=JSON.parse(e).filter(n=>n.type==="video"||n.type==="file");C({title:"\u{1F553} V\u1EEBa xem",folders:o,targetId:"section-recent"})}})();
