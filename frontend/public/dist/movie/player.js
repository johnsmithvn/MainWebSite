(()=>{function z(e,t=!1){let o=document.createElement("div");o.className="folder-card";let n=e.thumbnail?`<img src="${e.thumbnail}" alt="${e.name}" loading="lazy">`:'<div class="folder-thumb-placeholder">Kh\xF4ng c\xF3 \u1EA3nh</div>',a=e.name;e.name==="__self__"&&(a=e.path.split("/").at(-2)||"\u1EA2nh"),o.innerHTML=`
    <div class="folder-thumb">
      ${n}
      ${t&&e.count?`<div class="folder-views">\u{1F441} ${e.count}</div>`:""}
      <div class="folder-fav ${e.isFavorite?"active":""}" title="${e.isFavorite?"B\u1ECF y\xEAu th\xEDch":"Th\xEAm y\xEAu th\xEDch"}">${e.isFavorite?"\u2764\uFE0F":"\u{1F90D}"}</div>
    </div>
    <div class="folder-title">${a}</div>
  `,o.onclick=r=>{if(!r.target.classList.contains("folder-fav"))if(e.isSelfReader&&e.images){let c=encodeURIComponent(e.path);window.location.href=`/manga/reader.html?path=${c}`}else window.loadFolder?.(e.path)};let i=o.querySelector(".folder-fav");return i.onclick=async r=>{r.stopPropagation();let c=y(),s=k(),d=!e.isFavorite;e.isFavorite=d,i.classList.toggle("active",d),i.textContent=d?"\u2764\uFE0F":"\u{1F90D}",i.title=d?"B\u1ECF y\xEAu th\xEDch":"Th\xEAm y\xEAu th\xEDch";try{let m=c?.startsWith("V_");await fetch(m?"/api/movie/favorite-movie":"/api/manga/favorite",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dbkey:c,path:e.path,value:d})}),Q(c,s,e.path,d)}catch(m){console.warn("\u274C Kh\xF4ng th\u1EC3 l\u01B0u y\xEAu th\xEDch:",m)}},o}function Q(e,t,o,n){if(e?.startsWith("V_")){let r=`movieCache::${e}::`;for(let c in localStorage)if(c.startsWith(r))try{let s=localStorage.getItem(c),d=JSON.parse(s),m=!1;if(Array.isArray(d.data))for(let l of d.data)l.path===o&&(l.isFavorite=n,m=!0);m&&localStorage.setItem(c,JSON.stringify(d))}catch(s){console.warn("\u274C Kh\xF4ng th\u1EC3 update movieCache:",s)}["randomFolders","randomVideos"].forEach(c=>{let s=`${c}-${e}`,d=localStorage.getItem(s);if(d)try{let m=JSON.parse(d),l=!1;if(Array.isArray(m.data))for(let b of m.data)b.path===o&&(b.isFavorite=n,l=!0);l&&localStorage.setItem(s,JSON.stringify(m))}catch(m){console.warn("\u274C Kh\xF4ng th\u1EC3 update random cache:",m)}});return}let i=`folderCache::${e}::${t}`;for(let r in localStorage)if(r.startsWith(i))try{let c=localStorage.getItem(r),s=JSON.parse(c),d=!1;if(s.data&&s.data.folders)for(let m of s.data.folders)m.path===o&&(m.isFavorite=n,d=!0);s.data?.images&&o.endsWith("/__self__")&&(s.data.isFavorite=n,d=!0),d&&localStorage.setItem(r,JSON.stringify(s))}catch(c){console.warn("\u274C Kh\xF4ng th\u1EC3 update folderCache:",c)}try{let r=`recentViewed::${t}::${t}`,c=localStorage.getItem(r);if(c){let s=JSON.parse(c),d=!1;for(let m of s)m.path===o&&(m.isFavorite=n,d=!0);d&&localStorage.setItem(r,JSON.stringify(s))}}catch(r){console.warn("\u274C Kh\xF4ng th\u1EC3 update recentViewed:",r)}}function $({title:e,folders:t,showViews:o=!1,targetId:n,onRefresh:a=null}){let i=document.createElement("section");i.className="folder-section slider";let r=document.createElement("div");r.className="folder-section-header";let c=document.createElement("div");c.className="slider-left";let s=document.createElement("h3");s.className="folder-section-title",s.textContent=e,c.appendChild(s),r.appendChild(c);let d=e.toLowerCase().includes("v\u1EEBa xem")||e.toLowerCase().includes("v\u1EEBa nghe")||e.toLowerCase().includes("m\u1EDBi \u0111\u1ECDc")||e.toLowerCase().includes("nh\u1EA1c v\u1EEBa nghe");if(e.includes("ng\u1EABu nhi\xEAn")||d){let h=document.createElement("div");if(h.className="slider-right",e.includes("ng\u1EABu nhi\xEAn")){let u=document.createElement("button");u.id="refresh-random-btn",u.textContent="\u{1F504} Refresh",u.className="small-button",h.appendChild(u),u.onclick=()=>{typeof a=="function"&&a()};let g=document.createElement("span");g.className="random-timestamp",e.includes("Folder")?g.id="random-timestamp-folder":e.includes("Video")?g.id="random-timestamp-video":e.includes("B\xE0i h\xE1t")?g.id="random-timestamp-audio":g.id="random-timestamp",g.textContent="",h.appendChild(g)}if(d){let u=document.createElement("button");u.textContent="\u{1F5D1}\uFE0F Xo\xE1 t\u1EA5t c\u1EA3",u.className="small-button",u.onclick=()=>{let g,S;window.location.pathname.includes("movie")?(g=Z(),S=O):window.location.pathname.includes("music")?(g=me(),S=window.renderRecentViewedMusic||O):(g=de(),S=O),localStorage.removeItem(g),S([])},h.appendChild(u)}r.appendChild(h)}i.appendChild(r);let m=document.createElement("div");m.style.position="relative";let l=document.createElement("div");l.className="slider-wrapper",l.style.scrollSnapType="x mandatory",l.style.overflowX="auto";let b=window.location.pathname.includes("movie");t.forEach(h=>{let u=window.location.pathname.includes("music"),g=window.location.pathname.includes("movie"),S=!u&&!g,J="movie";u?J="music":S&&(J="manga");let ke=G(h,J),Se={...h,thumbnail:ke},W=z(Se,o);W.style.scrollSnapAlign="start",l.appendChild(W);let N=encodeURIComponent(h.path),_=y();W.onclick=be=>{if(be.target.classList.contains("folder-fav"))return;if(h.isPlaylist){let X=y();window.location.href=`/music/player.html?playlist=${encodeURIComponent(h.path)}&key=${X}`;return}let q=window.location.pathname.includes("music"),ce=window.location.pathname.includes("movie");if(q&&(h.type==="audio"||h.type==="file")||ce&&(h.type==="video"||h.type==="file")){let X=q?"music/player":"movie/player";window.location.href=`/${X}.html?file=${N}&key=${_}`;return}q?window.location.href=`/music/index.html?path=${N}&key=${_}`:ce?window.location.href=`/movie/index.html?path=${N}&key=${_}`:h.isSelfReader&&h.images?window.location.href=`/manga/reader.html?path=${N}`:typeof window.loadFolder=="function"&&window.loadFolder(h.path)}}),m.appendChild(l);let C=window.innerWidth<=768,B=document.createElement("button"),T=document.createElement("button");B.className="nav-button prev-button",T.className="nav-button next-button",B.innerHTML="\u2190",T.innerHTML="\u2192",C||(m.appendChild(B),m.appendChild(T)),i.appendChild(m);let M=document.createElement("div");M.className="slider-pagination",i.appendChild(M);let A=n?document.getElementById(n):document.getElementById(e.includes("ng\u1EABu nhi\xEAn")?"section-random":e.includes("Xem nhi\u1EC1u")?"section-topview":"section-recent");A&&(A.innerHTML="",A.appendChild(i));let R=l.querySelector(".folder-card")?.offsetWidth+16||200,ae=Math.ceil(t.length/5);B.onclick=()=>l.scrollBy({left:-R,behavior:"smooth"}),T.onclick=()=>l.scrollBy({left:R,behavior:"smooth"});for(let h=0;h<ae;h++){let u=document.createElement("span");u.className="pagination-dot",u.style.cursor="pointer",h===0&&u.classList.add("active"),u.onclick=()=>l.scrollTo({left:h*R*5,behavior:"smooth"}),M.appendChild(u)}l.addEventListener("scroll",()=>{let h=l.scrollLeft/(l.scrollWidth-l.clientWidth),u=Math.round(h*(ae-1));M.querySelectorAll(".pagination-dot").forEach((g,S)=>{g.classList.toggle("active",S===u)})});let F=0,E=null,we=()=>{let h=l.scrollWidth-l.clientWidth;F+=R*5,F>h&&(F=0),l.scrollTo({left:F,behavior:"smooth"})},ie=()=>{!C&&!E&&(E=setInterval(we,2e4))},re=()=>{E&&clearInterval(E),E=null};new IntersectionObserver(h=>{h[0].isIntersecting?ie():re()},{threshold:.5}).observe(i),l.addEventListener("mouseenter",re),l.addEventListener("mouseleave",ie)}function se(){["randomFolderSection","randomVideoSection"].forEach(e=>{if(!document.getElementById(e)){let t=document.createElement("section");t.id=e,document.body.prepend(t)}})}function le(e="movie"){let t=y(),o=e==="music",n=o?"/api/music/audio-cache":"/api/movie/video-cache";D("folder",t,"randomFolderSection",o?"\u{1F3B2} Th\u01B0 m\u1EE5c nh\u1EA1c ng\u1EABu nhi\xEAn":"\u{1F3B2} Folder ng\u1EABu nhi\xEAn",!1,n,"random-timestamp-folder"),D("file",t,o?"randomAudioSection":"randomVideoSection",o?"\u{1F3B5} B\xE0i h\xE1t ng\u1EABu nhi\xEAn":"\u{1F3AC} Video ng\u1EABu nhi\xEAn",!1,n,o?"random-timestamp-audio":"random-timestamp-video")}async function D(e,t,o,n,a=!1,i,r){if(!i){let s=window.location.pathname;s.includes("music")?i="/api/music/audio-cache":s.includes("movie")?i="/api/movie/video-cache":s.includes("manga")||s.includes("comic")||s.includes("reader")?i="/api/manga/folder-cache":i="/api/movie/video-cache"}if(!t)return;let c=`${e==="file"?i.includes("music")?"randomAudios":"randomVideos":"randomFolders"}-${t}`;if(r=r||(e==="file"?i.includes("music")?"random-timestamp-audio":"random-timestamp-video":"random-timestamp-folder"),!a){let s=localStorage.getItem(c);if(s)try{let d=JSON.parse(s);if(!(Date.now()-d.timestamp>30*60*1e3)){$({title:n,folders:d.data,targetId:o,onRefresh:()=>D(e,t,o,n,!0,i,r)}),document.getElementById(r)&&x(d.timestamp,r);return}}catch{}}try{let d=await(await fetch(`${i}?mode=random&type=${e}&key=${t}`)).json(),m=Array.isArray(d)?d:d.folders,l=Date.now();localStorage.setItem(c,JSON.stringify({data:m,timestamp:l})),$({title:n,folders:m,targetId:o,onRefresh:()=>D(e,t,o,n,!0,i,r)}),document.getElementById(r)&&x(l,r)}catch(s){console.error("\u274C L\u1ED7i random slider:",s)}}async function Ce(){let e=document.getElementById("floatingSearchInput")?.value.trim().toLowerCase(),t=document.getElementById("search-dropdown"),o=k(),n=y();if(!e){t.classList.add("hidden"),t.innerHTML="";return}t.classList.remove("hidden"),t.innerHTML='<div id="search-loader">\u{1F50D} \u0110ang t\xECm ki\u1EBFm...</div>';try{let i=await(await fetch(`/api/manga/folder-cache?mode=search&key=${encodeURIComponent(n)}&root=${encodeURIComponent(o)}&q=${encodeURIComponent(e)}`)).json();if(t.innerHTML="",i.length===0){t.innerHTML='<div id="search-loader">\u274C Kh\xF4ng t\xECm th\u1EA5y k\u1EBFt qu\u1EA3</div>';return}i.forEach(r=>{let c=document.createElement("div");c.className="search-item",c.innerHTML=`
        <img src="${r.thumbnail}" class="search-thumb" alt="thumb">
        <div class="search-title">${r.name}</div>
      `,c.onclick=()=>{t.classList.add("hidden"),window.location.pathname.includes("reader.html")?window.location.href=`/manga/index.html?path=${encodeURIComponent(r.path)}`:window.loadFolder?.(r.path)},t.appendChild(c)})}catch(a){t.innerHTML='<div id="search-loader">\u26A0\uFE0F L\u1ED7i khi t\xECm ki\u1EBFm</div>',console.error("\u274C L\u1ED7i t\xECm ki\u1EBFm:",a)}}async function he(){let e=document.getElementById("floatingSearchInput")?.value.trim().toLowerCase(),t=document.getElementById("search-dropdown"),o=localStorage.getItem("sourceKey"),n=document.getElementById("search-type-select")?.value||"video";if(!e){t.classList.add("hidden"),t.innerHTML="";return}t.classList.remove("hidden"),t.innerHTML='<div id="search-loader">\u{1F50D} \u0110ang t\xECm video...</div>';try{let i=await(await fetch(`/api/movie/video-cache?mode=search&key=${encodeURIComponent(o)}&q=${encodeURIComponent(e)}&type=${encodeURIComponent(n)}`)).json();if(t.innerHTML="",!i.folders||i.folders.length===0){t.innerHTML='<div id="search-loader">\u274C Kh\xF4ng t\xECm th\u1EA5y video n\xE0o</div>';return}i.folders.forEach(r=>{let c=document.createElement("div");c.className="search-item";let s=G(r,"movie");c.innerHTML=`
    <img src="${s}" class="search-thumb" alt="thumb">
    <div class="search-title">${r.name}</div>
  `,c.onclick=()=>{t.classList.add("hidden"),r.type==="video"||r.type==="file"?window.location.href=`/movie/player.html?file=${encodeURIComponent(r.path)}&key=${o}`:window.location.href=`/movie/index.html?path=${encodeURIComponent(r.path)}`},t.appendChild(c)})}catch(a){console.error("\u274C L\u1ED7i t\xECm ki\u1EBFm video:",a),t.innerHTML='<div id="search-loader">\u26A0\uFE0F L\u1ED7i khi t\xECm ki\u1EBFm</div>'}}function Y(){let e=document.getElementById("floating-search");e?.classList.toggle("active");let t=document.getElementById("floatingSearchInput");e?.classList.contains("active")?t?.focus():(t.value="",Ce())}function x(e,t="random-timestamp"){let o=document.getElementById(t);if(!o)return;let n=Math.floor((Date.now()-e)/6e4);window.innerWidth<=480?o.textContent=`\u{1F3B2} ${n===0?"now":`${n}m`}`:o.textContent=`\u{1F3B2} Random ${n===0?"v\u1EEBa xong":`${n} ph\xFAt tr\u01B0\u1EDBc`}`}function ee(e){$({title:"\u2728 \u0110\u1EC1 xu\u1EA5t ng\u1EABu nhi\xEAn",folders:e,showRefresh:!0})}function O(e=[]){let t=window.location.pathname.includes("movie"),o=t?e.filter(n=>n.type==="video"||n.type==="file"):e.filter(n=>!n.type||n.type!=="video"&&n.type!=="file");$({title:t?"\u{1F553} V\u1EEBa xem":"\u{1F558} M\u1EDBi \u0111\u1ECDc",folders:o,targetId:"section-recent"})}function L(e,t){let o=document.createElement("button");return o.textContent=e,o.onclick=t,o}function P(e){return async(...t)=>{let o=document.getElementById("loading-overlay");o?.classList.remove("hidden"),await new Promise(n=>requestAnimationFrame(()=>setTimeout(n,0)));try{await e(...t)}catch(n){console.error("\u274C withLoading error:",n)}finally{o?.classList.add("hidden")}}}function p(e){let t=document.getElementById("global-toast");t||(t=document.createElement("div"),t.id="global-toast",t.style.position="fixed",t.style.bottom="20px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.background="#333",t.style.color="white",t.style.padding="10px 20px",t.style.borderRadius="8px",t.style.zIndex="9999",t.style.fontSize="14px",document.body.appendChild(t)),t.textContent=e,t.style.display="block",setTimeout(()=>{t.style.display="none"},3e3)}function U(e,t={}){let o=document.getElementById("global-confirm");return o||(o=document.createElement("div"),o.id="global-confirm",o.className="modal-overlay hidden",o.innerHTML=`
      <div class="modal-box">
        <p id="confirm-text"></p>
        <div class="buttons">
          <button class="ok">OK</button>
          <button class="cancel">Hu\u1EF7</button>
        </div>
      </div>
    `,document.body.appendChild(o)),o.querySelector("#confirm-text").textContent=e,o.classList.remove("hidden"),new Promise(n=>{let a=o.querySelector("button.ok"),i=o.querySelector("button.cancel"),r=()=>{o.classList.add("hidden"),a.removeEventListener("click",c),i.removeEventListener("click",s)},c=()=>{r(),t.loading&&document.getElementById("loading-overlay")?.classList.remove("hidden"),n(!0)},s=()=>{r(),n(!1)};a.addEventListener("click",c),i.addEventListener("click",s)})}function ue(){let e=document.getElementById("sidebar-menu");if(!e)return;e.innerHTML="";let t=y();e.appendChild(L("\u{1F3AC} \u0110\u1ED5i Movie Folder",()=>{localStorage.removeItem("rootFolder"),window.location.href="/home.html"})),e.appendChild(L("\u{1F5D1} Xo\xE1 DB Movie",P(async()=>{if(await U("B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n xo\xE1 to\xE0n b\u1ED9 DB Movie?"))try{let a=await(await fetch(`/api/movie/reset-cache-movie?key=${t}&mode=delete`,{method:"DELETE"})).json();p(a.message||"\u2705 \u0110\xE3 xo\xE1 DB Movie"),window.location.reload()}catch(n){p("\u274C L\u1ED7i khi g\u1ECDi API xo\xE1 DB Movie"),console.error(n)}}))),e.appendChild(L("\u{1F5D1} Reset DB Movie (xo\u0301a va\u0300 scan)",P(async()=>{if(await U("B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n xo\xE1 to\xE0n b\u1ED9 DB Movie?",{loading:!0}))try{let a=await(await fetch(`/api/movie/reset-cache-movie?key=${t}&mode=reset`,{method:"DELETE"})).json();p(a.message||"\u2705 \u0110\xE3 xo\xE1 DB Movie"),window.location.reload()}catch(n){p("\u274C L\u1ED7i khi g\u1ECDi API xo\xE1 DB Movie"),console.error(n)}}))),e.appendChild(L("\u{1F4E6} Qu\xE9t th\u01B0 m\u1EE5c m\u1EDBi",P(async()=>{if(await U("Qu\xE9t folder m\u1EDBi (kh\xF4ng xo\xE1 DB)?",{}))try{let a=await(await fetch("/api/movie/scan-movie",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:t})})).json();p(`\u2705 Scan xong:
Inserted ${a.stats.inserted}, Updated ${a.stats.updated}, Skipped ${a.stats.skipped}`)}catch(n){p("\u274C L\u1ED7i khi qu\xE9t folder"),console.error(n)}}))),e.appendChild(L("\u{1F9FC} Xo\xE1 cache folder",P(async()=>{if(!await U("B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n xo\xE1 cache folder movie localStorage?"))return;let n=0;Object.keys(localStorage).forEach(a=>{a.startsWith(`movieCache::${t}::`)&&(localStorage.removeItem(a),n++)}),p(`\u2705 \u0110\xE3 xo\xE1 ${n} cache folder`)})))}function G(e,t="movie"){let o="/video/",n="/default/video-thumb.png",a="/default/folder-thumb.png";t==="music"?(o="/audio/",n="/default/music-thumb.png",a="/default/folder-thumb.png"):(t==="manga"||t==="comic")&&(o="/manga/",n="/default/manga-thumb.png",a="/default/folder-thumb.png");let i;return e.type==="folder"?i=e.path||"":i=e.path?.split("/").slice(0,-1).join("/")||"",e.thumbnail?e.thumbnail.startsWith(o)||e.thumbnail.startsWith("http")||e.thumbnail.startsWith("/default/")?e.thumbnail:(i&&e.thumbnail.startsWith(i+"/")&&(e.thumbnail=e.thumbnail.slice(i.length+1)),`${o}${i?i+"/":""}${e.thumbnail.replace(/\\/g,"/")}`):t==="music"?e.type==="audio"||e.type==="file"?n:a:t==="manga"||t==="comic"?e.type==="folder"?a:n:e.type==="video"||e.type==="file"?n:a}var Ie="movieCache::";function k(){return localStorage.getItem("rootFolder")}function y(){return localStorage.getItem("sourceKey")}function xe(e,t){return e?`${Ie}${e}::${t||""}`:null}function de(){return`recentViewed::${k()}::${k()}`}function pe(e,t){let o=xe(e,t),n=localStorage.getItem(o);if(!n)return null;try{let a=JSON.parse(n);return{data:a.data,timestamp:a.timestamp}}catch{return localStorage.removeItem(o),null}}function Z(){return`recentViewedVideo::${y()}`}function fe(e){let t=Z();try{let o=localStorage.getItem(t),a=(o?JSON.parse(o):[]).filter(r=>r.path!==e.path);a.unshift({name:e.name,path:e.path,thumbnail:e.thumbnail,type:"video"});let i=a.slice(0,30);localStorage.setItem(t,JSON.stringify(i))}catch(o){console.warn("\u274C Kh\xF4ng th\u1EC3 l\u01B0u recentViewedVideo:",o)}}function me(){return`recentViewedMusic::${y()}`}var Ee=new URLSearchParams(window.location.search),v=Ee.get("file"),f=y(),w=document.getElementById("video-player"),te=document.getElementById("fav-btn"),ge=document.getElementById("set-thumb-btn");if(!v||!f)throw p("\u274C Thi\u1EBFu file ho\u1EB7c sourceKey"),new Error("Missing file or sourceKey");var $e=`/api/movie/video?key=${f}&file=${encodeURIComponent(v)}`;w.src=$e;var j=v.split("/").filter(Boolean),ye=j[j.length-1];document.getElementById("video-name").textContent=ye;var H=j.slice(0,-1).join("/"),V=document.getElementById("movie-folder-name");V.textContent=j.at(-2)||"Home";V.title=H||"Quay l\u1EA1i th\u01B0 m\u1EE5c";V.classList.add("clickable-folder");V.onclick=()=>{let e=H,t=e?`/movie/index.html?path=${encodeURIComponent(e)}`:"/movie/index.html";window.location.href=t};var I=!1;async function Le(){try{I=!!(await(await fetch(`/api/movie/favorite-movie?key=${f}`)).json()).find(n=>n.path===v),ve()}catch(e){console.warn("\u274C Failed to check favorite:",e)}}function ve(){te.textContent=I?"\u2764\uFE0F":"\u{1F90D}",te.title=I?"B\u1ECF y\xEAu th\xEDch":"Th\xEAm y\xEAu th\xEDch"}te.onclick=async()=>{I=!I,ve();try{await fetch("/api/movie/favorite-movie",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dbkey:f,path:v,value:I})}),Q(f,k(),v,I)}catch(e){console.error("\u274C Failed to toggle favorite:",e),p("\u274C L\u1ED7i khi toggle y\xEAu th\xEDch")}};ge&&(ge.onclick=async()=>{try{await fetch("/api/movie/extract-thumbnail",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:f,path:v})}),await fetch("/api/movie/folder-thumbnail",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:f,folderPath:H,srcPath:v})}),p("\u2705 \u0110\xE3 \u0111\u1EB7t thumbnail")}catch(e){console.error("set-thumb error",e),p("\u274C L\u1ED7i \u0111\u1EB7t thumbnail")}});fetch("/api/increase-view/movie",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:f,path:v})}).catch(e=>{console.error("\u274C Failed to increase view:",e)});var Be=v.split("/").pop().replace(/\.(mp4|mkv|ts|avi|mov|webm|wmv)$/i,""),Te=`.thumbnail/${Be}.jpg`;fe({name:ye,path:v,thumbnail:Te,type:"video"});document.getElementById("searchToggle")?.addEventListener("click",Y);Me();async function Me(e=!1){let t=`randomVideos-${f}`,o="random-timestamp-video";if(!e){let n=localStorage.getItem(t);if(n)try{let a=JSON.parse(n);if(!(Date.now()-a.timestamp>30*60*1e3)){ee(a.data),x(a.timestamp,o);return}}catch{}}try{let a=await(await fetch(`/api/movie/video-cache?mode=random&type=file&key=${f}`)).json(),i=Array.isArray(a)?a:a.folders,r=Date.now();localStorage.setItem(t,JSON.stringify({data:i,timestamp:r})),ee(i),x(r,o)}catch(n){console.error("\u274C L\u1ED7i random video:",n)}}Le();document.getElementById("floatingSearchInput")?.addEventListener("input",he);document.getElementById("searchToggle")?.addEventListener("click",Y);se();le();Re(H,v);async function Re(e,t){let o=[],n=pe(f,e);if(n&&Array.isArray(n.data))o=n.data;else try{o=(await(await fetch(`/api/movie/movie-folder?key=${f}&path=${encodeURIComponent(e)}`)).json()).folders||[]}catch(l){console.error("\u274C L\u1ED7i khi load th\u01B0 m\u1EE5c:",l);return}let a=o.filter(l=>l.type==="video"||l.type==="file"),i=a.findIndex(l=>l.path===t);if(i===-1){p("\u274C Kh\xF4ng t\xECm th\u1EA5y video hi\u1EC7n t\u1EA1i trong th\u01B0 m\u1EE5c");return}let r=a[i-1],c=a[i+1],s=document.getElementById("btn-prev"),d=document.getElementById("btn-next");s.disabled=!r,d.disabled=!c,r&&(s.onclick=()=>{window.location.href=`/movie/player.html?file=${encodeURIComponent(r.path)}&key=${f}`}),c&&(d.onclick=()=>{window.location.href=`/movie/player.html?file=${encodeURIComponent(c.path)}&key=${f}`});let m=document.getElementById("video-episode-list");m.innerHTML="",a.forEach((l,b)=>{let C=document.createElement("button");C.textContent=`T\u1EADp ${b+1}`,l.path===t&&C.classList.add("active"),C.onclick=()=>{l.path!==t&&(window.location.href=`/movie/player.html?file=${encodeURIComponent(l.path)}&key=${f}`)},m.appendChild(C)})}document.getElementById("btn-random-jump").onclick=async()=>{try{let t=await(await fetch(`/api/movie/video-cache?mode=random&type=file&key=${f}`)).json(),n=(Array.isArray(t)?t:t.folders).filter(i=>i.type==="video"||i.type==="file");if(!n.length)return p("\u274C Kh\xF4ng c\xF3 video ng\u1EABu nhi\xEAn");let a=n[Math.floor(Math.random()*n.length)];if(!a?.path)return p("\u274C Video l\u1ED7i");window.location.href=`/movie/player.html?file=${encodeURIComponent(a.path)}&key=${f}`}catch(e){console.error("\u274C L\u1ED7i khi random jump:",e),p("\u274C Kh\xF4ng th\u1EC3 t\u1EA3i video ng\u1EABu nhi\xEAn")}};document.getElementById("sidebarToggle")?.addEventListener("click",()=>{let e=document.getElementById("sidebar-menu");e&&e.classList.toggle("active")});ue();var K=10;w.addEventListener("dblclick",e=>{let t=e.clientX,o=w.clientWidth;t<o/2?(w.currentTime=Math.max(0,w.currentTime-K),p(`\u23EA L\xF9i ${K}s`)):(w.currentTime=Math.min(w.duration,w.currentTime+K),p(`\u23E9 Tua ${K}s`))});var ne=new Hammer(w);ne.get("pan").set({direction:Hammer.DIRECTION_HORIZONTAL});var oe=0;ne.on("pan",e=>{oe=e.deltaX});ne.on("panend",()=>{let e=Math.floor(oe/10);e!==0&&(w.currentTime=Math.max(0,Math.min(w.duration,w.currentTime+e)),p(`${e>0?"\u23E9":"\u23EA"} ${Math.abs(e)}s`)),oe=0});document.getElementById("btn-open-exoplayer")?.addEventListener("click",()=>{let e=`${location.origin}/api/movie/video?key=${f}&file=${encodeURIComponent(v)}`;window.Android?.openExoPlayer?window.Android.openExoPlayer(e):p("\u274C \u1EE8ng d\u1EE5ng kh\xF4ng h\u1ED7 tr\u1EE3 ExoPlayer")});})();
