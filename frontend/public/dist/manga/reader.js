(()=>{var be=Object.defineProperty;var V=(e,t)=>()=>(e&&(t=e(e=0)),t);var G=(e,t)=>{for(var n in t)be(e,n,{get:t[n],enumerable:!0})};function Q(e,t,n=10){document.querySelectorAll('link[rel="preload"][as="image"]').forEach(o=>{o.remove()});let r=Math.max(0,e-n),a=Math.min(t.length-1,e+n);for(let o=r;o<=a;o++){if(o===e)continue;let i=document.createElement("link");i.rel="preload",i.as="image",i.href=t[o],document.head.appendChild(i)}}function E(e,t){let n=document.getElementById("page-info");n&&(n.textContent=`Trang ${e} / ${t}`)}function pe(e,t,n){let r=document.getElementById("page-info");if(!r)return;let a=document.createElement("input");a.type="number",a.min=1,a.max=t,a.placeholder="Nh\u1EADp trang...",a.style.width="60px",a.style.fontSize="14px",a.style.textAlign="center",r.innerHTML="",r.appendChild(a),a.focus(),a.onblur=a.onchange=()=>{let o=parseInt(a.value,10);!isNaN(o)&&o>=1&&o<=t&&n(o-1)}}function Me(e,t){e.forEach(n=>{let r=document.getElementById(n);r&&r.classList[t]("hidden")})}function K(){Me(Te,"toggle")}var Te,z=V(()=>{Te=["site-header","reader-footer","readerModeButton"]});var fe={};G(fe,{renderScrollReader:()=>Pe});function Pe(e,t,n=()=>{},r=0){let a=Math.ceil(e.length/D),o=[];for(let u=0;u<a;u++)o.push(e.slice(u*D,(u+1)*D));let i=document.createElement("div");i.className="reader scroll-mode",t.appendChild(i);let c=r;l(o[c]),d(i,o[c]),h(),i.addEventListener("click",K),window.onscroll=h;let s=document.getElementById("page-info");s&&(s.style.cursor="pointer",s.onclick=null,s.onclick=()=>F(),E(c+1,a));function l(u){i.innerHTML="";for(let v=0;v<u.length;v++){let p=document.createElement("img");p.src=u[v],p.className="scroll-img loading",p.loading="lazy",p.onload=()=>p.classList.remove("loading"),i.appendChild(p)}}function d(u,v){let p=()=>u.querySelectorAll("img").length;window.onscroll=()=>{let b=u.lastElementChild;if(!b)return;if(b.getBoundingClientRect().bottom<window.innerHeight+300){let $=p(),I=v.slice($,$+Fe);for(let S of I){let T=document.createElement("img");T.src=S,T.className="scroll-img",T.loading="lazy",u.appendChild(T)}}h()}}function h(){let u=i.querySelectorAll(".scroll-img"),v=window.innerHeight/2,p=1/0,b=0;for(let S=0;S<u.length;S++){let T=u[S].getBoundingClientRect(),ke=T.top+T.height/2,Z=Math.abs(ke-v);Z<p&&(p=Z,b=S)}let R=c*D+b,$=e.length,I=document.getElementById("image-count-info");I&&(I.textContent=`\u1EA2nh ${R+1} / ${$} (Hi\u1EC7n: ${u.length})`),n(R)}function m(u){c=u,l(o[c]),d(i,o[c]),E(c+1,a),C(i)}function C(u){let p=u.getBoundingClientRect().top+window.scrollY;window.scrollTo({top:p,behavior:"instant"})}function F(){let u=document.createElement("div");u.className="scroll-page-modal",Object.assign(u.style,{position:"fixed",top:0,left:0,width:"100%",height:"100%",background:"rgba(0,0,0,0.6)",display:"flex",justifyContent:"center",alignItems:"center",zIndex:9999});let v=document.createElement("div");Object.assign(v.style,{background:"white",padding:"20px",borderRadius:"10px",maxHeight:"80vh",overflowY:"auto",display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(60px, 1fr))",gap:"10px",maxWidth:"400px"});for(let I=0;I<a;I++){let S=document.createElement("button");S.textContent=`${I+1}`,S.onclick=()=>{m(I),u.remove()},v.appendChild(S)}let p=document.createElement("div");p.style.textAlign="center",p.style.marginTop="12px";let b=document.createElement("button"),R=document.createElement("button");b.textContent="\u2B05 Prev",R.textContent="Next \u27A1",b.onclick=()=>{c>0&&m(c-1)},R.onclick=()=>{c<a-1&&m(c+1)},p.appendChild(b),p.appendChild(R);let $=document.createElement("div");$.appendChild(v),$.appendChild(p),u.appendChild($),u.onclick=I=>{I.target===u&&u.remove()},document.body.appendChild(u)}function B(u){let v=Math.floor(u/D);c=v,m(v),E(c+1,a)}return{setCurrentPage:B}}var D,Fe,ge=V(()=>{z();D=200,Fe=50});var ve={};G(ve,{renderHorizontalReader:()=>Ne});function Ne(e,t,n=()=>{},r=0){if(!e||e.length===0)return;console.log("\u2705 Swiper version:",window.Swiper?.version),t.innerHTML="",t.classList.add("reader");let a=document.createElement("div");a.className="swiper";let o=document.createElement("div");o.className="swiper-wrapper",a.appendChild(o),t.appendChild(a);let i=e.map(l=>{let d=document.createElement("div");d.className="swiper-slide",d.style.position="relative",d.style.zIndex=10;let h=document.createElement("div");h.className="pinch-zoom";let m=document.createElement("img");return m.src=l,m.className="loading",m.style.zIndex=10,m.style.position="relative",m.onload=()=>m.classList.remove("loading"),h.appendChild(m),d.appendChild(h),d}),c=null,s=r;return setTimeout(()=>{c=new Swiper(a,{initialSlide:s,loop:!1,virtual:{slides:i,renderSlide:(l,d)=>l},on:{slideChange:()=>{c&&(s=c.activeIndex,Q(s,e),E(s+1,e.length),n(s),setTimeout(ye,100))}}}),setTimeout(()=>{c.virtual.update(),console.log("\u{1F9E9} DOM slide count:",document.querySelectorAll(".swiper-slide").length)},100),setTimeout(()=>{let l=document.querySelector(".swiper-slide img");l&&(l.onload=()=>{document.getElementById("loading-overlay")?.classList.add("hidden")})},1e3),Q(s,e),E(s+1,e.length),n(s),setTimeout(ye,100),t.__readerControl={setCurrentPage:l=>{c&&c.slideTo(l)}}},50),a.addEventListener("click",l=>Ue(l,a,c)),{setCurrentPage(l){c?(s=l,c.slideTo(l)):setTimeout(()=>{t.__readerControl?.setCurrentPage?.(l)},100)}}}function ye(){document.querySelectorAll(".pinch-zoom").forEach(e=>{e.__pinchZoomInitialized||(e.__pinchZoomInitialized=!0,new window.PinchZoom.default(e,{draggableUnzoomed:!1,tapZoomFactor:2}))})}function Ue(e,t,n){if(H!==null){H=clearTimeout(H);return}H=setTimeout(()=>{H=null;let a=e.target.closest(".pinch-zoom")?.style?.transform;if(!a||a.includes("scale(1")){let{clientX:o}=e,{width:i,left:c}=t.getBoundingClientRect(),s=o-c,l=i*.25;s<l?n.slidePrev():s>i-l?n.slideNext():K()}},120)}var H,we=V(()=>{z();H=null});function Y(e=[]){let t=document.head||document.getElementsByTagName("head")[0];e.forEach(n=>{if(n.thumbnail){let r=document.createElement("link");r.rel="preload",r.as="image",r.href=n.thumbnail,t.querySelector(`link[rel="preload"][href="${n.thumbnail}"]`)||t.appendChild(r)}})}function J(e,t=!1){let n=document.createElement("div");n.className="folder-card";let r=e.thumbnail?`<img src="${e.thumbnail}" alt="${e.name}" loading="lazy">`:'<div class="folder-thumb-placeholder">Kh\xF4ng c\xF3 \u1EA3nh</div>',a=e.name;e.name==="__self__"&&(a=e.path.split("/").at(-2)||"\u1EA2nh"),n.innerHTML=`
    <div class="folder-thumb">
      ${r}
      ${t&&e.count?`<div class="folder-views">\u{1F441} ${e.count}</div>`:""}
      <div class="folder-fav ${e.isFavorite?"active":""}" title="${e.isFavorite?"B\u1ECF y\xEAu th\xEDch":"Th\xEAm y\xEAu th\xEDch"}">${e.isFavorite?"\u2764\uFE0F":"\u{1F90D}"}</div>
    </div>
    <div class="folder-title">${a}</div>
  `,n.onclick=i=>{if(!i.target.classList.contains("folder-fav"))if(e.isSelfReader&&e.images){let c=encodeURIComponent(e.path);window.location.href=`/manga/reader.html?path=${c}`}else window.loadFolder?.(e.path)};let o=n.querySelector(".folder-fav");return o.onclick=async i=>{i.stopPropagation();let c=w(),s=g(),l=!e.isFavorite;e.isFavorite=l,o.classList.toggle("active",l),o.textContent=l?"\u2764\uFE0F":"\u{1F90D}",o.title=l?"B\u1ECF y\xEAu th\xEDch":"Th\xEAm y\xEAu th\xEDch";try{let d=c?.startsWith("V_");await fetch(d?"/api/movie/favorite-movie":"/api/manga/favorite",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dbkey:c,path:e.path,value:l})}),Ee(c,s,e.path,l)}catch(d){console.warn("\u274C Kh\xF4ng th\u1EC3 l\u01B0u y\xEAu th\xEDch:",d)}},n}function Ee(e,t,n,r){if(e?.startsWith("V_")){let i=`movieCache::${e}::`;for(let c in localStorage)if(c.startsWith(i))try{let s=localStorage.getItem(c),l=JSON.parse(s),d=!1;if(Array.isArray(l.data))for(let h of l.data)h.path===n&&(h.isFavorite=r,d=!0);d&&localStorage.setItem(c,JSON.stringify(l))}catch(s){console.warn("\u274C Kh\xF4ng th\u1EC3 update movieCache:",s)}["randomFolders","randomVideos"].forEach(c=>{let s=`${c}-${e}`,l=localStorage.getItem(s);if(l)try{let d=JSON.parse(l),h=!1;if(Array.isArray(d.data))for(let m of d.data)m.path===n&&(m.isFavorite=r,h=!0);h&&localStorage.setItem(s,JSON.stringify(d))}catch(d){console.warn("\u274C Kh\xF4ng th\u1EC3 update random cache:",d)}});return}let o=`folderCache::${e}::${t}`;for(let i in localStorage)if(i.startsWith(o))try{let c=localStorage.getItem(i),s=JSON.parse(c),l=!1;if(s.data&&s.data.folders)for(let d of s.data.folders)d.path===n&&(d.isFavorite=r,l=!0);s.data?.images&&n.endsWith("/__self__")&&(s.data.isFavorite=r,l=!0),l&&localStorage.setItem(i,JSON.stringify(s))}catch(c){console.warn("\u274C Kh\xF4ng th\u1EC3 update folderCache:",c)}try{let i=`recentViewed::${t}::${t}`,c=localStorage.getItem(i);if(c){let s=JSON.parse(c),l=!1;for(let d of s)d.path===n&&(d.isFavorite=r,l=!0);l&&localStorage.setItem(i,JSON.stringify(s))}}catch(i){console.warn("\u274C Kh\xF4ng th\u1EC3 update recentViewed:",i)}}var y={currentPath:"",allFolders:[]},P=0,U=24,ee=0;function M(e="",t=0){let n=g(),r=w();y.currentPath=e,P=t,document.getElementById("loading-overlay")?.classList.remove("hidden");let a=document.getElementById("readerModeButton");a&&a.remove();let o=oe(r,n,e);if(o&&o.data){te(o.data),document.getElementById("loading-overlay")?.classList.add("hidden");return}fetch(`/api/manga/folder-cache?mode=path&key=${encodeURIComponent(r)}&root=${encodeURIComponent(n)}&path=${encodeURIComponent(e)}`).then(i=>i.json()).then(i=>{ae(r,n,e,i),te(i)}).catch(i=>{console.error("\u274C L\u1ED7i khi load folder:",i),f("\u{1F6AB} L\u1ED7i khi t\u1EA3i th\u01B0 m\u1EE5c, vui l\xF2ng th\u1EED l\u1EA1i!")}).finally(()=>{document.getElementById("loading-overlay")?.classList.add("hidden")})}function te(e){console.log("\u{1F4E6} Data render:",e);let t=document.getElementById("app");if(t.innerHTML="",e.type==="folder"){if(y.allFolders=[],e.images&&e.images.length>0){let o=y.currentPath.split("/"),i=o[o.length-1]||"Xem \u1EA3nh";y.allFolders.push({name:i,path:y.currentPath+"/__self__",thumbnail:e.images[0],isSelfReader:!0,images:e.images,hasImages:!0})}y.allFolders=y.allFolders.concat(e.folders),ee=y.allFolders.length;let n=y.allFolders.slice(P*U,(P+1)*U),r=y.allFolders.slice((P+1)*U,(P+2)*U),a=[...n,...r];Y(a),$e(n),ne(P,ee,U)}else if(e.type==="reader"){document.getElementById("loading-overlay")?.classList.remove("hidden");let n=encodeURIComponent(y.currentPath);window.location.href=`/manga/reader.html?path=${n}`}}function $e(e){let t=document.getElementById("app");t.innerHTML="";let n=document.createElement("section");n.className="folder-section grid";let r=document.createElement("div");r.className="folder-section-header";let a=document.createElement("h3");a.className="folder-section-title";let o=y.currentPath.split("/").filter(Boolean),i=o[o.length-1];a.textContent=o.length===0?"\u{1F4C2} Th\u01B0 m\u1EE5c":`\u{1F4C1} ${i}`,o.length>0&&(a.style.cursor="pointer",a.title="Click \u0111\u1EC3 quay v\u1EC1 th\u01B0 m\u1EE5c cha",a.onclick=()=>{let s=o.slice(0,-1).join("/");M(s)},a.style.maxWidth="100%",a.style.overflow="hidden",a.style.textOverflow="ellipsis",a.style.whiteSpace="nowrap"),r.appendChild(a),n.appendChild(r);let c=document.createElement("div");c.className="grid",e.forEach(s=>{let l=J(s,!0);c.appendChild(l)}),n.appendChild(c),t.appendChild(n)}async function W(){let e=document.getElementById("floatingSearchInput")?.value.trim().toLowerCase(),t=document.getElementById("search-dropdown"),n=g(),r=w();if(!e){t.classList.add("hidden"),t.innerHTML="";return}t.classList.remove("hidden"),t.innerHTML='<div id="search-loader">\u{1F50D} \u0110ang t\xECm ki\u1EBFm...</div>';try{let o=await(await fetch(`/api/manga/folder-cache?mode=search&key=${encodeURIComponent(r)}&root=${encodeURIComponent(n)}&q=${encodeURIComponent(e)}`)).json();if(t.innerHTML="",o.length===0){t.innerHTML='<div id="search-loader">\u274C Kh\xF4ng t\xECm th\u1EA5y k\u1EBFt qu\u1EA3</div>';return}o.forEach(i=>{let c=document.createElement("div");c.className="search-item",c.innerHTML=`
        <img src="${i.thumbnail}" class="search-thumb" alt="thumb">
        <div class="search-title">${i.name}</div>
      `,c.onclick=()=>{t.classList.add("hidden"),window.location.pathname.includes("reader.html")?window.location.href=`/manga/index.html?path=${encodeURIComponent(i.path)}`:window.loadFolder?.(i.path)},t.appendChild(c)})}catch(a){t.innerHTML='<div id="search-loader">\u26A0\uFE0F L\u1ED7i khi t\xECm ki\u1EBFm</div>',console.error("\u274C L\u1ED7i t\xECm ki\u1EBFm:",a)}}function ne(e,t,n,r,a=null){let o=Math.ceil(t/n),i=a||document.getElementById("app");if(!i)return;let c=document.createElement("div");c.className="reader-controls";let s=document.createElement("button");s.textContent="\u2B05 Trang tr\u01B0\u1EDBc",s.disabled=e<=0,s.onclick=()=>M(y.currentPath,e-1),c.appendChild(s);let l=document.createElement("form");l.style.display="inline-block",l.style.margin="0 10px",l.onsubmit=F=>{F.preventDefault();let B=parseInt(d.value)-1;!isNaN(B)&&B>=0&&M(y.currentPath,B)};let d=document.createElement("input");d.type="number",d.min=1,d.max=o,d.placeholder="Trang...",d.title=`T\u1ED5ng ${o} trang`,d.style.width="60px";let h=document.createElement("button");h.textContent="\u23E9",l.appendChild(d),l.appendChild(h),c.appendChild(l);let m=document.createElement("button");m.textContent="Trang sau \u27A1",m.disabled=e+1>=o,m.onclick=()=>M(y.currentPath,e+1),c.appendChild(m),i.appendChild(c);let C=document.createElement("div");C.textContent=`Trang ${e+1} / ${o}`,C.style.textAlign="center",C.style.marginTop="10px",i.appendChild(C)}function re(){let e=document.getElementById("floating-search");e?.classList.toggle("active");let t=document.getElementById("floatingSearchInput");e?.classList.contains("active")?t?.focus():(t.value="",W())}function O(e,t){let n=document.createElement("button");return n.textContent=e,n.onclick=t,n}function ce(){let e=document.getElementById("sidebar-menu");if(!e)return;e.innerHTML="";let t=g(),n=w();e.appendChild(O("\u{1F504} \u0110\u1ED5i Manga Folder",()=>{le()})),e.appendChild(O("\u{1F5D1} Xo\xE1 DB",async()=>{if(await A("B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n xo\xE1 to\xE0n b\u1ED9 DB kh\xF4ng?",{loading:!0}))try{let o=await(await fetch(`/api/manga/reset-cache?root=${encodeURIComponent(t)}&key=${encodeURIComponent(n)}&mode=delete`,{method:"DELETE"})).json();f(o.message||"\u2705 \u0110\xE3 xo\xE1 DB")}catch{f("\u274C L\u1ED7i khi g\u1ECDi API")}finally{document.getElementById("loading-overlay")?.classList.add("hidden")}})),e.appendChild(O("\u{1F504} Reset DB (Xo\xE1 + Scan)",q(async()=>{if(!await A("B\u1EA1n ch\u1EAFc mu\u1ED1n reset v\xE0 scan l\u1EA1i DB?"))return;let o=await(await fetch(`/api/manga/reset-cache?root=${encodeURIComponent(t)}&key=${encodeURIComponent(n)}&mode=reset`,{method:"DELETE"})).json();f(o.message||"\u2705 Reset DB xong")}))),e.appendChild(O("\u{1F4E6} Qu\xE9t th\u01B0 m\u1EE5c m\u1EDBi",q(async()=>{if(await A("Qu\xE9t folder m\u1EDBi (kh\xF4ng xo\xE1 DB)?"))try{let o=await(await fetch("/api/manga/scan",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({root:t,key:n})})).json();f(`\u2705 Scan xong:
Inserted ${o.stats.inserted}, Updated ${o.stats.updated}, Skipped ${o.stats.skipped}`)}catch(a){f("\u274C L\u1ED7i khi qu\xE9t folder"),console.error(a)}}))),e.appendChild(O("\u{1F9FC} Xo\xE1 cache folder",q(async()=>{if(!await A("B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n xo\xE1 cache folder localStorage?"))return;let a=w(),o=0;Object.keys(localStorage).forEach(i=>{i.startsWith(`folderCache::${a}::`)&&(localStorage.removeItem(i),o++)}),window.location.href="/home.html",f(`\u2705 \u0110\xE3 xo\xE1 ${o} cache folder`)})))}function se(){let e=document.getElementById("sidebar-menu");e&&e.classList.toggle("active")}function q(e){return async(...t)=>{let n=document.getElementById("loading-overlay");n?.classList.remove("hidden"),await new Promise(r=>requestAnimationFrame(()=>setTimeout(r,0)));try{await e(...t)}catch(r){console.error("\u274C withLoading error:",r)}finally{n?.classList.add("hidden")}}}function f(e){let t=document.getElementById("global-toast");t||(t=document.createElement("div"),t.id="global-toast",t.style.position="fixed",t.style.bottom="20px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.background="#333",t.style.color="white",t.style.padding="10px 20px",t.style.borderRadius="8px",t.style.zIndex="9999",t.style.fontSize="14px",document.body.appendChild(t)),t.textContent=e,t.style.display="block",setTimeout(()=>{t.style.display="none"},3e3)}function A(e,t={}){let n=document.getElementById("global-confirm");return n||(n=document.createElement("div"),n.id="global-confirm",n.className="modal-overlay hidden",n.innerHTML=`
      <div class="modal-box">
        <p id="confirm-text"></p>
        <div class="buttons">
          <button class="ok">OK</button>
          <button class="cancel">Hu\u1EF7</button>
        </div>
      </div>
    `,document.body.appendChild(n)),n.querySelector("#confirm-text").textContent=e,n.classList.remove("hidden"),new Promise(r=>{let a=n.querySelector("button.ok"),o=n.querySelector("button.cancel"),i=()=>{n.classList.add("hidden"),a.removeEventListener("click",c),o.removeEventListener("click",s)},c=()=>{i(),t.loading&&document.getElementById("loading-overlay")?.classList.remove("hidden"),r(!0)},s=()=>{i(),r(!1)};a.addEventListener("click",c),o.addEventListener("click",s)})}var X="folderCache::",Le="rootThumb::";function g(){return localStorage.getItem("rootFolder")}function w(){return localStorage.getItem("sourceKey")}function le(){localStorage.removeItem("rootFolder"),window.location.href="/manga/select.html"}function de(){g()||(f("\u26A0\uFE0F Ch\u01B0a ch\u1ECDn th\u01B0 m\u1EE5c g\u1ED1c, vui l\xF2ng ch\u1ECDn l\u1EA1i!"),window.location.href="/manga/select.html")}function me(e,t,n){let r=`${Le}${e}::${t}`,a={thumbnail:n,time:Date.now()};localStorage.setItem(r,JSON.stringify(a))}function ue(e,t,n){if(!e)return null;let r=`${X}${e}`;return t&&(r+=`::${t}`),n&&(r+=`:${n}`),r}function oe(e,t,n){let r=ue(e,t,n),a=localStorage.getItem(r);if(!a)return null;try{let o=JSON.parse(a);return{data:o.data,timestamp:o.timestamp}}catch{return localStorage.removeItem(r),null}}function ae(e,t,n,r){if(!e||t===null||t===void 0){let s=`\u26A0\uFE0F Kh\xF4ng cache \u0111\u01B0\u1EE3c do thi\u1EBFu th\xF4ng tin: sourceKey = ${e}, rootFolder = ${t}`;console.warn(s),f(s);return}if(!r||Array.isArray(r.folders)&&r.folders.length===0&&Array.isArray(r.images)&&r.images.length===0){console.warn("\u26A0\uFE0F D\u1EEF li\u1EC7u r\u1ED7ng, kh\xF4ng l\u01B0u cache:",n);return}let a=ue(e,t,n),o=JSON.stringify({timestamp:Date.now(),data:r}),i=4*1024*1024+300,c=Be();if(o.length>i){console.warn(`\u26A0\uFE0F Folder qu\xE1 l\u1EDBn, kh\xF4ng cache localStorage: ${n}`);return}c+o.length>i&&(size=i-o.length,size>i/2&&(size=i/2),Re(size)),localStorage.setItem(a,o)}function Be(){let e=0;for(let t in localStorage)if(t.startsWith(X)){let n=localStorage.getItem(t);e+=n?.length||0}return e}function Re(e){let t=[];for(let r in localStorage)if(r.startsWith(X))try{let a=localStorage.getItem(r),o=JSON.parse(a);t.push({key:r,size:a.length,timestamp:o.timestamp||0})}catch{localStorage.removeItem(r)}t.sort((r,a)=>r.timestamp-a.timestamp);let n=0;for(let r of t)if(localStorage.removeItem(r.key),n+=r.size,n>=e)break;console.log(`\u{1F9F9} D\u1ECDn cache: \u0111\xE3 xo\xE1 ${n} byte`)}function ie(){return`recentViewed::${g()}::${g()}`}function he(e){let t=ie();try{let n=localStorage.getItem(t),a=(n?JSON.parse(n):[]).filter(i=>i.path!==e.path);a.unshift({name:e.name,path:e.path,thumbnail:e.thumbnail});let o=a.slice(0,30);localStorage.setItem(t,JSON.stringify(o))}catch(n){console.warn("\u274C Kh\xF4ng th\u1EC3 l\u01B0u recentViewed:",n)}}z();var L=null,N=null,_=[],k=0,x="horizontal";function j(e,t=!1,n=0){let a=new URLSearchParams(window.location.search).get("path"),o=a.split("/"),i=o[o.length-1]==="__self__"?o[o.length-2]||"Xem \u1EA3nh":o[o.length-1]||"Xem \u1EA3nh";_e(i),he({name:i,path:a,thumbnail:e[0]||null});let c=w(),s=g();if(!c)return;t||fetch("/api/increase-view",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:a,dbkey:c,rootKey:s})}),_=e,t||(k=0);let l=document.getElementById("app");L||(L=document.createElement("div"),L.id="reader",L.className="reader",l.appendChild(L),Oe(),Ie(),He()),L.innerHTML="",L.classList.toggle("scroll-mode",x==="vertical"),(x==="vertical"?Promise.resolve().then(()=>(ge(),fe)):Promise.resolve().then(()=>(we(),ve))).then(({renderScrollReader:h,renderHorizontalReader:m})=>{N=(x==="vertical"?h:m)(e,L,B=>{k=B},x==="vertical"?n:k),x==="horizontal"&&(E(k+1,_.length),Ie());let F=document.getElementById("image-count-info");F&&(F.style.display=x==="vertical"?"block":"none")})}function Oe(){if(document.getElementById("readerModeButton"))return;let e=document.createElement("button");e.id="readerModeButton",e.textContent="\u{1F4D6}",e.title="\u0110\u1ED5i ch\u1EBF \u0111\u1ED9 \u0111\u1ECDc",Object.assign(e.style,{position:"fixed",bottom:"60px",left:"16px",zIndex:1e3,padding:"12px 14px",fontSize:"20px",borderRadius:"50%",border:"none",background:"#444",color:"white",boxShadow:"0 2px 8px rgba(0,0,0,0.3)",cursor:"pointer"}),e.onclick=De,document.body.appendChild(e)}function De(){let e=0;if(x==="vertical"){let n=document.getElementById("image-count-info")?.textContent?.match(/Ảnh (\d+)/);n&&(k=parseInt(n[1])-1),x="horizontal"}else e=Math.floor(k/200),x="vertical";j(_,!0,e),setTimeout(()=>{N?.setCurrentPage&&(x==="horizontal"?N.setCurrentPage(k):N.setCurrentPage(e*200))},0)}function xe(){return _[k]||null}function He(){let e=document.getElementById("prev-chapter-btn"),t=document.getElementById("next-chapter-btn");!e||!t||(e.onclick=()=>Ce("prev"),t.onclick=()=>Ce("next"))}function Ce(e="next"){let t=g(),n=w(),a=new URLSearchParams(window.location.search).get("path")||"";if(a=a.replace(/\/__self__$/,""),!n||!t||!a){alert("\u274C Thi\u1EBFu key, root ho\u1EB7c path!");return}fetch(`/api/manga/next-chapter?key=${encodeURIComponent(n)}&root=${encodeURIComponent(t)}&path=${encodeURIComponent(a)}&dir=${e}`).then(o=>o.json()).then(o=>{if(!o.path){alert(e==="next"?"\u{1F6AB} H\u1EBFt ch\u01B0\u01A1ng!":"\u{1F6AB} \u0110\xE2y l\xE0 ch\u01B0\u01A1ng \u0111\u1EA7u!");return}fetch(`/api/manga/folder-cache?mode=path&key=${encodeURIComponent(n)}&root=${encodeURIComponent(t)}&path=${encodeURIComponent(o.path)}`).then(i=>i.json()).then(i=>{let c=m=>m.replace(/\/__self__$/,""),s=Array.isArray(i.images)&&i.images.length>0,l=c(o.path)===c(a),d=!s&&(!i.folders||i.folders.length===0);if(l&&d){let m=a.split("/").filter(Boolean);if(m.length>=2){let C=m.slice(0,-1).join("/");M(C)}else alert("\u274C Kh\xF4ng c\xF2n folder cha!");return}let h=!s&&Array.isArray(i.folders)&&i.folders.length>0;if(s){let m=o.path;i.folders?.length>0&&(m+="/__self__");let C=`${window.location.pathname}?path=${encodeURIComponent(m)}`;window.history.replaceState({},"",C),j(i.images)}else if(h){window.location.href=`/manga/index.html?path=${encodeURIComponent(o.path)}`;return}})}).catch(o=>{console.error("\u274C L\u1ED7i chuy\u1EC3n ch\u01B0\u01A1ng:",o),alert("\u274C L\u1ED7i k\u1EBFt n\u1ED1i server")})}function Ie(){let e=document.getElementById("page-info");e&&(e.onclick=()=>{x!=="vertical"&&pe(k,_.length,t=>{k=t,N?.setCurrentPage&&N.setCurrentPage(t)})})}function _e(e){let t=document.getElementById("reader-folder-name");t&&(t.textContent=e,t.title=e,t.classList.add("clickable-folder"),t.onclick=()=>{let a=(new URLSearchParams(window.location.search).get("path")||"").split("/").filter(Boolean);a.pop();let o=a.join("/");o?window.location.replace(`/manga/index.html?path=${encodeURIComponent(o)}`):window.location.replace("/manga/index.html")})}function Se(){document.addEventListener("click",e=>{let t=document.getElementById("sidebar-menu"),n=document.getElementById("sidebarToggle"),r=t?.contains(e.target),a=n?.contains(e.target);t?.classList.contains("active")&&!r&&!a&&t.classList.remove("active");let o=document.getElementById("search-dropdown"),i=document.getElementById("floatingSearchInput");o&&i&&(o.contains(e.target)||i.contains(e.target)||o.classList.add("hidden"))})}window.addEventListener("DOMContentLoaded",Ae);async function Ae(){document.getElementById("loading-overlay")?.classList.remove("hidden");let e=w(),t=g();de();let r=new URLSearchParams(window.location.search).get("path");if(!r){f("\u274C Thi\u1EBFu path \u0111\u1ECDc truy\u1EC7n!");return}let a=r;try{let i=await(await fetch(`/api/manga/folder-cache?mode=path&key=${encodeURIComponent(e)}&root=${encodeURIComponent(t)}&path=${encodeURIComponent(a)}`)).json();i.type==="reader"&&Array.isArray(i.images)?(document.getElementById("loading-overlay")?.classList.add("hidden"),j(i.images),Ke()):f("\u274C Folder n\xE0y kh\xF4ng ch\u1EE9a \u1EA3nh ho\u1EB7c kh\xF4ng h\u1EE3p l\u1EC7!")}catch(o){console.error("\u274C L\u1ED7i load reader:",o),f("\u{1F6AB} Kh\xF4ng th\u1EC3 t\u1EA3i d\u1EEF li\u1EC7u!")}}function Ke(){ce(),Se(),document.getElementById("sidebarToggle")?.addEventListener("click",se),document.getElementById("searchToggle")?.addEventListener("click",re),document.getElementById("floatingSearchInput")?.addEventListener("input",W),document.getElementById("setThumbnailBtn")?.addEventListener("click",ze)}async function ze(){let e=xe();if(!e)return;let t=w(),n=g();try{await fetch("/api/manga/root-thumbnail",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:t,root:n,thumbnail:e.replace(`/manga/${encodeURIComponent(n)}/`,"")})}),me(t,n,e.replace(`/manga/${encodeURIComponent(n)}/`,"")),f("\u2705 \u0110\xE3 l\u01B0u thumbnail")}catch(r){console.error("set root thumbnail",r),f("\u274C L\u1ED7i set thumbnail")}}})();
