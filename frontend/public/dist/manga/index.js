(()=>{var W="folderCache::";function v(){return localStorage.getItem("rootFolder")}function y(){return localStorage.getItem("sourceKey")}function N(){localStorage.removeItem("rootFolder"),window.location.href="/manga/select.html"}function ee(){v()||(p("\u26A0\uFE0F Ch\u01B0a ch\u1ECDn th\u01B0 m\u1EE5c g\u1ED1c, vui l\xF2ng ch\u1ECDn l\u1EA1i!"),window.location.href="/manga/select.html")}function te(e,t,o){if(!e)return null;let n=`${W}${e}`;return t&&(n+=`::${t}`),o&&(n+=`:${o}`),n}function oe(e,t,o){let n=te(e,t,o),i=localStorage.getItem(n);if(!i)return null;try{let a=JSON.parse(i);return{data:a.data,timestamp:a.timestamp}}catch{return localStorage.removeItem(n),null}}function ne(e,t,o,n){if(!e||t===null||t===void 0){let s=`\u26A0\uFE0F Kh\xF4ng cache \u0111\u01B0\u1EE3c do thi\u1EBFu th\xF4ng tin: sourceKey = ${e}, rootFolder = ${t}`;console.warn(s),p(s);return}if(!n||Array.isArray(n.folders)&&n.folders.length===0&&Array.isArray(n.images)&&n.images.length===0){console.warn("\u26A0\uFE0F D\u1EEF li\u1EC7u r\u1ED7ng, kh\xF4ng l\u01B0u cache:",o);return}let i=te(e,t,o),a=JSON.stringify({timestamp:Date.now(),data:n}),r=4*1024*1024+300,c=Ce();if(a.length>r){console.warn(`\u26A0\uFE0F Folder qu\xE1 l\u1EDBn, kh\xF4ng cache localStorage: ${o}`);return}c+a.length>r&&(size=r-a.length,size>r/2&&(size=r/2),ke(size)),localStorage.setItem(i,a)}function Ce(){let e=0;for(let t in localStorage)if(t.startsWith(W)){let o=localStorage.getItem(t);e+=o?.length||0}return e}function ke(e){let t=[];for(let n in localStorage)if(n.startsWith(W))try{let i=localStorage.getItem(n),a=JSON.parse(i);t.push({key:n,size:i.length,timestamp:a.timestamp||0})}catch{localStorage.removeItem(n)}t.sort((n,i)=>n.timestamp-i.timestamp);let o=0;for(let n of t)if(localStorage.removeItem(n.key),o+=n.size,o>=e)break;console.log(`\u{1F9F9} D\u1ECDn cache: \u0111\xE3 xo\xE1 ${o} byte`)}function D(){return`recentViewed::${v()}::${v()}`}function ae(){return`recentViewedVideo::${y()}`}function ie(){return`recentViewedMusic::${y()}`}function O(e,t=!1){let o=document.createElement("div");o.className="folder-card";let n=e.thumbnail?`<img src="${e.thumbnail}" alt="${e.name}" loading="lazy">`:'<div class="folder-thumb-placeholder">Kh\xF4ng c\xF3 \u1EA3nh</div>',i=e.name;e.name==="__self__"&&(i=e.path.split("/").at(-2)||"\u1EA2nh"),o.innerHTML=`
    <div class="folder-thumb">
      ${n}
      ${t&&e.count?`<div class="folder-views">\u{1F441} ${e.count}</div>`:""}
      <div class="folder-fav ${e.isFavorite?"active":""}" title="${e.isFavorite?"B\u1ECF y\xEAu th\xEDch":"Th\xEAm y\xEAu th\xEDch"}">${e.isFavorite?"\u2764\uFE0F":"\u{1F90D}"}</div>
    </div>
    <div class="folder-title">${i}</div>
  `,o.onclick=r=>{if(!r.target.classList.contains("folder-fav"))if(e.isSelfReader&&e.images){let c=encodeURIComponent(e.path);window.location.href=`/manga/reader.html?path=${c}`}else window.loadFolder?.(e.path)};let a=o.querySelector(".folder-fav");return a.onclick=async r=>{r.stopPropagation();let c=y(),s=v(),l=!e.isFavorite;e.isFavorite=l,a.classList.toggle("active",l),a.textContent=l?"\u2764\uFE0F":"\u{1F90D}",a.title=l?"B\u1ECF y\xEAu th\xEDch":"Th\xEAm y\xEAu th\xEDch";try{let d=c?.startsWith("V_");await fetch(d?"/api/movie/favorite-movie":"/api/manga/favorite",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dbkey:c,path:e.path,value:l})}),Ie(c,s,e.path,l)}catch(d){console.warn("\u274C Kh\xF4ng th\u1EC3 l\u01B0u y\xEAu th\xEDch:",d)}},o}function Ie(e,t,o,n){if(e?.startsWith("V_")){let r=`movieCache::${e}::`;for(let c in localStorage)if(c.startsWith(r))try{let s=localStorage.getItem(c),l=JSON.parse(s),d=!1;if(Array.isArray(l.data))for(let h of l.data)h.path===o&&(h.isFavorite=n,d=!0);d&&localStorage.setItem(c,JSON.stringify(l))}catch(s){console.warn("\u274C Kh\xF4ng th\u1EC3 update movieCache:",s)}["randomFolders","randomVideos"].forEach(c=>{let s=`${c}-${e}`,l=localStorage.getItem(s);if(l)try{let d=JSON.parse(l),h=!1;if(Array.isArray(d.data))for(let w of d.data)w.path===o&&(w.isFavorite=n,h=!0);h&&localStorage.setItem(s,JSON.stringify(d))}catch(d){console.warn("\u274C Kh\xF4ng th\u1EC3 update random cache:",d)}});return}let a=`folderCache::${e}::${t}`;for(let r in localStorage)if(r.startsWith(a))try{let c=localStorage.getItem(r),s=JSON.parse(c),l=!1;if(s.data&&s.data.folders)for(let d of s.data.folders)d.path===o&&(d.isFavorite=n,l=!0);s.data?.images&&o.endsWith("/__self__")&&(s.data.isFavorite=n,l=!0),l&&localStorage.setItem(r,JSON.stringify(s))}catch(c){console.warn("\u274C Kh\xF4ng th\u1EC3 update folderCache:",c)}try{let r=`recentViewed::${t}::${t}`,c=localStorage.getItem(r);if(c){let s=JSON.parse(c),l=!1;for(let d of s)d.path===o&&(d.isFavorite=n,l=!0);l&&localStorage.setItem(r,JSON.stringify(s))}}catch(r){console.warn("\u274C Kh\xF4ng th\u1EC3 update recentViewed:",r)}}function U({title:e,folders:t,showViews:o=!1,targetId:n,onRefresh:i=null}){let a=document.createElement("section");a.className="folder-section slider";let r=document.createElement("div");r.className="folder-section-header";let c=document.createElement("div");c.className="slider-left";let s=document.createElement("h3");s.className="folder-section-title",s.textContent=e,c.appendChild(s),r.appendChild(c);let l=e.toLowerCase().includes("v\u1EEBa xem")||e.toLowerCase().includes("v\u1EEBa nghe")||e.toLowerCase().includes("m\u1EDBi \u0111\u1ECDc")||e.toLowerCase().includes("nh\u1EA1c v\u1EEBa nghe");if(e.includes("ng\u1EABu nhi\xEAn")||l){let m=document.createElement("div");if(m.className="slider-right",e.includes("ng\u1EABu nhi\xEAn")){let u=document.createElement("button");u.id="refresh-random-btn",u.textContent="\u{1F504} Refresh",u.className="small-button",m.appendChild(u),u.onclick=()=>{typeof i=="function"&&i()};let f=document.createElement("span");f.className="random-timestamp",e.includes("Folder")?f.id="random-timestamp-folder":e.includes("Video")?f.id="random-timestamp-video":e.includes("B\xE0i h\xE1t")?f.id="random-timestamp-audio":f.id="random-timestamp",f.textContent="",m.appendChild(f)}if(l){let u=document.createElement("button");u.textContent="\u{1F5D1}\uFE0F Xo\xE1 t\u1EA5t c\u1EA3",u.className="small-button",u.onclick=()=>{let f,C;window.location.pathname.includes("movie")?(f=ae(),C=x):window.location.pathname.includes("music")?(f=ie(),C=window.renderRecentViewedMusic||x):(f=D(),C=x),localStorage.removeItem(f),C([])},m.appendChild(u)}r.appendChild(m)}a.appendChild(r);let d=document.createElement("div");d.style.position="relative";let h=document.createElement("div");h.className="slider-wrapper",h.style.scrollSnapType="x mandatory",h.style.overflowX="auto";let w=window.location.pathname.includes("movie");t.forEach(m=>{let u=window.location.pathname.includes("music"),f=window.location.pathname.includes("movie"),C=!u&&!f,K="movie";u?K="music":C&&(K="manga");let ve=re(m,K),we={...m,thumbnail:ve},H=O(we,o);H.style.scrollSnapAlign="start",h.appendChild(H);let F=encodeURIComponent(m.path),j=y();H.onclick=Se=>{if(Se.target.classList.contains("folder-fav"))return;if(m.isPlaylist){let J=y();window.location.href=`/music/player.html?playlist=${encodeURIComponent(m.path)}&key=${J}`;return}let A=window.location.pathname.includes("music"),Z=window.location.pathname.includes("movie");if(A&&(m.type==="audio"||m.type==="file")||Z&&(m.type==="video"||m.type==="file")){let J=A?"music/player":"movie/player";window.location.href=`/${J}.html?file=${F}&key=${j}`;return}A?window.location.href=`/music/index.html?path=${F}&key=${j}`:Z?window.location.href=`/movie/index.html?path=${F}&key=${j}`:m.isSelfReader&&m.images?window.location.href=`/manga/reader.html?path=${F}`:typeof window.loadFolder=="function"&&window.loadFolder(m.path)}}),d.appendChild(h);let I=window.innerWidth<=768,b=document.createElement("button"),S=document.createElement("button");b.className="nav-button prev-button",S.className="nav-button next-button",b.innerHTML="\u2190",S.innerHTML="\u2192",I||(d.appendChild(b),d.appendChild(S)),a.appendChild(d);let M=document.createElement("div");M.className="slider-pagination",a.appendChild(M);let V=n?document.getElementById(n):document.getElementById(e.includes("ng\u1EABu nhi\xEAn")?"section-random":e.includes("Xem nhi\u1EC1u")?"section-topview":"section-recent");V&&(V.innerHTML="",V.appendChild(a));let R=h.querySelector(".folder-card")?.offsetWidth+16||200,Q=Math.ceil(t.length/5);b.onclick=()=>h.scrollBy({left:-R,behavior:"smooth"}),S.onclick=()=>h.scrollBy({left:R,behavior:"smooth"});for(let m=0;m<Q;m++){let u=document.createElement("span");u.className="pagination-dot",u.style.cursor="pointer",m===0&&u.classList.add("active"),u.onclick=()=>h.scrollTo({left:m*R*5,behavior:"smooth"}),M.appendChild(u)}h.addEventListener("scroll",()=>{let m=h.scrollLeft/(h.scrollWidth-h.clientWidth),u=Math.round(m*(Q-1));M.querySelectorAll(".pagination-dot").forEach((f,C)=>{f.classList.toggle("active",C===u)})});let T=0,$=null,ye=()=>{let m=h.scrollWidth-h.clientWidth;T+=R*5,T>m&&(T=0),h.scrollTo({left:T,behavior:"smooth"})},G=()=>{!I&&!$&&($=setInterval(ye,2e4))},Y=()=>{$&&clearInterval($),$=null};new IntersectionObserver(m=>{m[0].isIntersecting?G():Y()},{threshold:.5}).observe(a),h.addEventListener("mouseenter",Y),h.addEventListener("mouseleave",G)}async function z(){let e=document.getElementById("floatingSearchInput")?.value.trim().toLowerCase(),t=document.getElementById("search-dropdown"),o=v(),n=y();if(!e){t.classList.add("hidden"),t.innerHTML="";return}t.classList.remove("hidden"),t.innerHTML='<div id="search-loader">\u{1F50D} \u0110ang t\xECm ki\u1EBFm...</div>';try{let a=await(await fetch(`/api/manga/folder-cache?mode=search&key=${encodeURIComponent(n)}&root=${encodeURIComponent(o)}&q=${encodeURIComponent(e)}`)).json();if(t.innerHTML="",a.length===0){t.innerHTML='<div id="search-loader">\u274C Kh\xF4ng t\xECm th\u1EA5y k\u1EBFt qu\u1EA3</div>';return}a.forEach(r=>{let c=document.createElement("div");c.className="search-item",c.innerHTML=`
        <img src="${r.thumbnail}" class="search-thumb" alt="thumb">
        <div class="search-title">${r.name}</div>
      `,c.onclick=()=>{t.classList.add("hidden"),window.location.pathname.includes("reader.html")?window.location.href=`/manga/index.html?path=${encodeURIComponent(r.path)}`:window.loadFolder?.(r.path)},t.appendChild(c)})}catch(i){t.innerHTML='<div id="search-loader">\u26A0\uFE0F L\u1ED7i khi t\xECm ki\u1EBFm</div>',console.error("\u274C L\u1ED7i t\xECm ki\u1EBFm:",i)}}function ce(){document.body.classList.toggle("dark-mode")}function se(e,t,o,n,i=null){let a=Math.ceil(t/o),r=i||document.getElementById("app");if(!r)return;let c=document.createElement("div");c.className="reader-controls";let s=document.createElement("button");s.textContent="\u2B05 Trang tr\u01B0\u1EDBc",s.disabled=e<=0,s.onclick=()=>k(g.currentPath,e-1),c.appendChild(s);let l=document.createElement("form");l.style.display="inline-block",l.style.margin="0 10px",l.onsubmit=b=>{b.preventDefault();let S=parseInt(d.value)-1;!isNaN(S)&&S>=0&&k(g.currentPath,S)};let d=document.createElement("input");d.type="number",d.min=1,d.max=a,d.placeholder="Trang...",d.title=`T\u1ED5ng ${a} trang`,d.style.width="60px";let h=document.createElement("button");h.textContent="\u23E9",l.appendChild(d),l.appendChild(h),c.appendChild(l);let w=document.createElement("button");w.textContent="Trang sau \u27A1",w.disabled=e+1>=a,w.onclick=()=>k(g.currentPath,e+1),c.appendChild(w),r.appendChild(c);let I=document.createElement("div");I.textContent=`Trang ${e+1} / ${a}`,I.style.textAlign="center",I.style.marginTop="10px",r.appendChild(I)}function X(){let e=document.getElementById("floating-search");e?.classList.toggle("active");let t=document.getElementById("floatingSearchInput");e?.classList.contains("active")?t?.focus():(t.value="",z())}function _(e,t="random-timestamp"){let o=document.getElementById(t);if(!o)return;let n=Math.floor((Date.now()-e)/6e4);window.innerWidth<=480?o.textContent=`\u{1F3B2} ${n===0?"now":`${n}m`}`:o.textContent=`\u{1F3B2} Random ${n===0?"v\u1EEBa xong":`${n} ph\xFAt tr\u01B0\u1EDBc`}`}function le(e){U({title:"\u2728 \u0110\u1EC1 xu\u1EA5t ng\u1EABu nhi\xEAn",folders:e,showRefresh:!0})}function de(e){U({title:"\u{1F451} Xem nhi\u1EC1u nh\u1EA5t",folders:e,showViews:!0})}function x(e=[]){let t=window.location.pathname.includes("movie"),o=t?e.filter(n=>n.type==="video"||n.type==="file"):e.filter(n=>!n.type||n.type!=="video"&&n.type!=="file");U({title:t?"\u{1F553} V\u1EEBa xem":"\u{1F558} M\u1EDBi \u0111\u1ECDc",folders:o,targetId:"section-recent"})}function L(e,t){let o=document.createElement("button");return o.textContent=e,o.onclick=t,o}function me(){let e=document.getElementById("sidebar-menu");if(!e)return;e.innerHTML="";let t=v(),o=y();e.appendChild(L("\u{1F504} \u0110\u1ED5i Manga Folder",()=>{N()})),e.appendChild(L("\u{1F5D1} Xo\xE1 DB",async()=>{if(await P("B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n xo\xE1 to\xE0n b\u1ED9 DB kh\xF4ng?",{loading:!0}))try{let a=await(await fetch(`/api/manga/reset-cache?root=${encodeURIComponent(t)}&key=${encodeURIComponent(o)}&mode=delete`,{method:"DELETE"})).json();p(a.message||"\u2705 \u0110\xE3 xo\xE1 DB")}catch{p("\u274C L\u1ED7i khi g\u1ECDi API")}finally{document.getElementById("loading-overlay")?.classList.add("hidden")}})),e.appendChild(L("\u{1F504} Reset DB (Xo\xE1 + Scan)",q(async()=>{if(!await P("B\u1EA1n ch\u1EAFc mu\u1ED1n reset v\xE0 scan l\u1EA1i DB?"))return;let a=await(await fetch(`/api/manga/reset-cache?root=${encodeURIComponent(t)}&key=${encodeURIComponent(o)}&mode=reset`,{method:"DELETE"})).json();p(a.message||"\u2705 Reset DB xong")}))),e.appendChild(L("\u{1F4E6} Qu\xE9t th\u01B0 m\u1EE5c m\u1EDBi",q(async()=>{if(await P("Qu\xE9t folder m\u1EDBi (kh\xF4ng xo\xE1 DB)?"))try{let a=await(await fetch("/api/manga/scan",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({root:t,key:o})})).json();p(`\u2705 Scan xong:
Inserted ${a.stats.inserted}, Updated ${a.stats.updated}, Skipped ${a.stats.skipped}`)}catch(i){p("\u274C L\u1ED7i khi qu\xE9t folder"),console.error(i)}}))),e.appendChild(L("\u{1F9FC} Xo\xE1 cache folder",q(async()=>{if(!await P("B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n xo\xE1 cache folder localStorage?"))return;let i=y(),a=0;Object.keys(localStorage).forEach(r=>{r.startsWith(`folderCache::${i}::`)&&(localStorage.removeItem(r),a++)}),window.location.href="/home.html",p(`\u2705 \u0110\xE3 xo\xE1 ${a} cache folder`)})))}function he(){let e=document.getElementById("sidebar-menu");e&&e.classList.toggle("active")}function q(e){return async(...t)=>{let o=document.getElementById("loading-overlay");o?.classList.remove("hidden"),await new Promise(n=>requestAnimationFrame(()=>setTimeout(n,0)));try{await e(...t)}catch(n){console.error("\u274C withLoading error:",n)}finally{o?.classList.add("hidden")}}}function p(e){let t=document.getElementById("global-toast");t||(t=document.createElement("div"),t.id="global-toast",t.style.position="fixed",t.style.bottom="20px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.background="#333",t.style.color="white",t.style.padding="10px 20px",t.style.borderRadius="8px",t.style.zIndex="9999",t.style.fontSize="14px",document.body.appendChild(t)),t.textContent=e,t.style.display="block",setTimeout(()=>{t.style.display="none"},3e3)}function P(e,t={}){let o=document.getElementById("global-confirm");return o||(o=document.createElement("div"),o.id="global-confirm",o.className="modal-overlay hidden",o.innerHTML=`
      <div class="modal-box">
        <p id="confirm-text"></p>
        <div class="buttons">
          <button class="ok">OK</button>
          <button class="cancel">Hu\u1EF7</button>
        </div>
      </div>
    `,document.body.appendChild(o)),o.querySelector("#confirm-text").textContent=e,o.classList.remove("hidden"),new Promise(n=>{let i=o.querySelector("button.ok"),a=o.querySelector("button.cancel"),r=()=>{o.classList.add("hidden"),i.removeEventListener("click",c),a.removeEventListener("click",s)},c=()=>{r(),t.loading&&document.getElementById("loading-overlay")?.classList.remove("hidden"),n(!0)},s=()=>{r(),n(!1)};i.addEventListener("click",c),a.addEventListener("click",s)})}function re(e,t="movie"){let o="/video/",n="/default/video-thumb.png",i="/default/folder-thumb.png";t==="music"?(o="/audio/",n="/default/music-thumb.png",i="/default/folder-thumb.png"):(t==="manga"||t==="comic")&&(o="/manga/",n="/default/manga-thumb.png",i="/default/folder-thumb.png");let a;return e.type==="folder"?a=e.path||"":a=e.path?.split("/").slice(0,-1).join("/")||"",e.thumbnail?e.thumbnail.startsWith(o)||e.thumbnail.startsWith("http")||e.thumbnail.startsWith("/default/")?e.thumbnail:(a&&e.thumbnail.startsWith(a+"/")&&(e.thumbnail=e.thumbnail.slice(a.length+1)),`${o}${a?a+"/":""}${e.thumbnail.replace(/\\/g,"/")}`):t==="music"?e.type==="audio"||e.type==="file"?n:i:t==="manga"||t==="comic"?e.type==="folder"?i:n:e.type==="video"||e.type==="file"?n:i}function ue(e=[]){let t=document.head||document.getElementsByTagName("head")[0];e.forEach(o=>{if(o.thumbnail){let n=document.createElement("link");n.rel="preload",n.as="image",n.href=o.thumbnail,t.querySelector(`link[rel="preload"][href="${o.thumbnail}"]`)||t.appendChild(n)}})}var g={currentPath:"",allFolders:[]},E=0,B=24,pe=0;function k(e="",t=0){let o=v(),n=y();g.currentPath=e,E=t,document.getElementById("loading-overlay")?.classList.remove("hidden");let i=document.getElementById("readerModeButton");i&&i.remove();let a=oe(n,o,e);if(a&&a.data){fe(a.data),document.getElementById("loading-overlay")?.classList.add("hidden");return}fetch(`/api/manga/folder-cache?mode=path&key=${encodeURIComponent(n)}&root=${encodeURIComponent(o)}&path=${encodeURIComponent(e)}`).then(r=>r.json()).then(r=>{ne(n,o,e,r),fe(r)}).catch(r=>{console.error("\u274C L\u1ED7i khi load folder:",r),p("\u{1F6AB} L\u1ED7i khi t\u1EA3i th\u01B0 m\u1EE5c, vui l\xF2ng th\u1EED l\u1EA1i!")}).finally(()=>{document.getElementById("loading-overlay")?.classList.add("hidden")})}function fe(e){console.log("\u{1F4E6} Data render:",e);let t=document.getElementById("app");if(t.innerHTML="",e.type==="folder"){if(g.allFolders=[],e.images&&e.images.length>0){let a=g.currentPath.split("/"),r=a[a.length-1]||"Xem \u1EA3nh";g.allFolders.push({name:r,path:g.currentPath+"/__self__",thumbnail:e.images[0],isSelfReader:!0,images:e.images,hasImages:!0})}g.allFolders=g.allFolders.concat(e.folders),pe=g.allFolders.length;let o=g.allFolders.slice(E*B,(E+1)*B),n=g.allFolders.slice((E+1)*B,(E+2)*B),i=[...o,...n];ue(i),be(o),se(E,pe,B)}else if(e.type==="reader"){document.getElementById("loading-overlay")?.classList.remove("hidden");let o=encodeURIComponent(g.currentPath);window.location.href=`/manga/reader.html?path=${o}`}}function be(e){let t=document.getElementById("app");t.innerHTML="";let o=document.createElement("section");o.className="folder-section grid";let n=document.createElement("div");n.className="folder-section-header";let i=document.createElement("h3");i.className="folder-section-title";let a=g.currentPath.split("/").filter(Boolean),r=a[a.length-1];i.textContent=a.length===0?"\u{1F4C2} Th\u01B0 m\u1EE5c":`\u{1F4C1} ${r}`,a.length>0&&(i.style.cursor="pointer",i.title="Click \u0111\u1EC3 quay v\u1EC1 th\u01B0 m\u1EE5c cha",i.onclick=()=>{let s=a.slice(0,-1).join("/");k(s)},i.style.maxWidth="100%",i.style.overflow="hidden",i.style.textOverflow="ellipsis",i.style.whiteSpace="nowrap"),n.appendChild(i),o.appendChild(n);let c=document.createElement("div");c.className="grid",e.forEach(s=>{let l=O(s,!0);c.appendChild(l)}),o.appendChild(c),t.appendChild(o)}function ge(){document.addEventListener("click",e=>{let t=document.getElementById("sidebar-menu"),o=document.getElementById("sidebarToggle"),n=t?.contains(e.target),i=o?.contains(e.target);t?.classList.contains("active")&&!n&&!i&&t.classList.remove("active");let a=document.getElementById("search-dropdown"),r=document.getElementById("floatingSearchInput");a&&r&&(a.contains(e.target)||r.contains(e.target)||a.classList.add("hidden"))})}window.loadFolder=k;window.toggleDarkMode=ce;window.toggleSearchBar=X;window.changeRootFolder=N;window.getRootFolder=v;window.addEventListener("DOMContentLoaded",xe);async function xe(){let e=y();if(!e)return p("\u26A0\uFE0F Ch\u01B0a ch\u1ECDn ngu\u1ED3n d\u1EEF li\u1EC7u, vui l\xF2ng ch\u1ECDn l\u1EA1i!"),window.location.href="/home.html";if(e.startsWith("V_"))return window.location.href="/movie/index.html";if(e.startsWith("M_"))return window.location.href="/music/index.html";let t=v();ee(),me(),ge();let n=new URLSearchParams(window.location.search).get("path")||"";k(n),await Ee(e,t),await $e(e,t),Le(),document.getElementById("floatingSearchInput")?.addEventListener("input",z),document.getElementById("searchToggle")?.addEventListener("click",X),document.getElementById("sidebarToggle")?.addEventListener("click",he);let i=document.getElementById("site-header"),a=document.getElementById("wrapper");i&&a&&(a.style.paddingTop=`${i.offsetHeight}px`),document.getElementById("reset-cache-btn")?.addEventListener("click",Be)}async function Ee(e,t){let o=`randomView::${e}::${t}`,n=null;try{let i=localStorage.getItem(o);if(i){let{data:a,time:r}=JSON.parse(i);Date.now()-r<30*60*1e3&&(n=a,console.log("\u26A1 D\xF9ng cache random t\u1EEB localStorage"))}}catch(i){console.warn("\u274C L\u1ED7i \u0111\u1ECDc cache random:",i)}if(n||(n=await(await fetch(`/api/manga/folder-cache?mode=random&key=${encodeURIComponent(e)}&root=${encodeURIComponent(t)}`)).json(),localStorage.setItem(o,JSON.stringify({data:n,time:Date.now()}))),Array.isArray(n)){le(n);let{time:i}=JSON.parse(localStorage.getItem(o));_(i),document.getElementById("refresh-random-btn")?.addEventListener("click",()=>{localStorage.removeItem(o),location.reload()})}}async function $e(e,t){try{let n=await(await fetch(`/api/manga/folder-cache?mode=top&key=${encodeURIComponent(e)}&root=${encodeURIComponent(t)}`)).json();Array.isArray(n)&&de(n)}catch(o){console.error("\u274C L\u1ED7i fetch top view:",o)}}function Le(){let e=localStorage.getItem(D());if(e){let t=JSON.parse(e);x(t)}}async function Be(){let e=v();if(!e)return p("\u274C Ch\u01B0a ch\u1ECDn root!");if(confirm(`Reset cache cho '${e}'?`))try{(await(await fetch(`/api/manga/reset-cache?root=${encodeURIComponent(e)}`,{method:"DELETE"})).json()).success?(p("\u2705 Reset xong!"),location.reload()):p("\u274C Reset th\u1EA5t b\u1EA1i!")}catch(t){p("\u{1F6AB} L\u1ED7i k\u1EBFt n\u1ED1i API reset"),console.error(t)}}window.addEventListener("pageshow",e=>{if(e.persisted){let t=new URLSearchParams(window.location.search).get("path")||"";window.loadFolder?.(t)}});})();
