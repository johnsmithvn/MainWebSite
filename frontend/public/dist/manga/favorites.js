(()=>{function L(e=[]){let t=document.head||document.getElementsByTagName("head")[0];e.forEach(o=>{if(o.thumbnail){let n=document.createElement("link");n.rel="preload",n.as="image",n.href=o.thumbnail,t.querySelector(`link[rel="preload"][href="${o.thumbnail}"]`)||t.appendChild(n)}})}function C(e,t=!1){let o=document.createElement("div");o.className="folder-card";let n=e.thumbnail?`<img src="${e.thumbnail}" alt="${e.name}" loading="lazy">`:'<div class="folder-thumb-placeholder">Kh\xF4ng c\xF3 \u1EA3nh</div>',i=e.name;e.name==="__self__"&&(i=e.path.split("/").at(-2)||"\u1EA2nh"),o.innerHTML=`
    <div class="folder-thumb">
      ${n}
      ${t&&e.count?`<div class="folder-views">\u{1F441} ${e.count}</div>`:""}
      <div class="folder-fav ${e.isFavorite?"active":""}" title="${e.isFavorite?"B\u1ECF y\xEAu th\xEDch":"Th\xEAm y\xEAu th\xEDch"}">${e.isFavorite?"\u2764\uFE0F":"\u{1F90D}"}</div>
    </div>
    <div class="folder-title">${i}</div>
  `,o.onclick=r=>{if(!r.target.classList.contains("folder-fav"))if(e.isSelfReader&&e.images){let c=encodeURIComponent(e.path);window.location.href=`/manga/reader.html?path=${c}`}else window.loadFolder?.(e.path)};let a=o.querySelector(".folder-fav");return a.onclick=async r=>{r.stopPropagation();let c=u(),s=g(),l=!e.isFavorite;e.isFavorite=l,a.classList.toggle("active",l),a.textContent=l?"\u2764\uFE0F":"\u{1F90D}",a.title=l?"B\u1ECF y\xEAu th\xEDch":"Th\xEAm y\xEAu th\xEDch";try{let d=c?.startsWith("V_");await fetch(d?"/api/movie/favorite-movie":"/api/manga/favorite",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dbkey:c,path:e.path,value:l})}),O(c,s,e.path,l)}catch(d){console.warn("\u274C Kh\xF4ng th\u1EC3 l\u01B0u y\xEAu th\xEDch:",d)}},o}function O(e,t,o,n){if(e?.startsWith("V_")){let r=`movieCache::${e}::`;for(let c in localStorage)if(c.startsWith(r))try{let s=localStorage.getItem(c),l=JSON.parse(s),d=!1;if(Array.isArray(l.data))for(let h of l.data)h.path===o&&(h.isFavorite=n,d=!0);d&&localStorage.setItem(c,JSON.stringify(l))}catch(s){console.warn("\u274C Kh\xF4ng th\u1EC3 update movieCache:",s)}["randomFolders","randomVideos"].forEach(c=>{let s=`${c}-${e}`,l=localStorage.getItem(s);if(l)try{let d=JSON.parse(l),h=!1;if(Array.isArray(d.data))for(let f of d.data)f.path===o&&(f.isFavorite=n,h=!0);h&&localStorage.setItem(s,JSON.stringify(d))}catch(d){console.warn("\u274C Kh\xF4ng th\u1EC3 update random cache:",d)}});return}let a=`folderCache::${e}::${t}`;for(let r in localStorage)if(r.startsWith(a))try{let c=localStorage.getItem(r),s=JSON.parse(c),l=!1;if(s.data&&s.data.folders)for(let d of s.data.folders)d.path===o&&(d.isFavorite=n,l=!0);s.data?.images&&o.endsWith("/__self__")&&(s.data.isFavorite=n,l=!0),l&&localStorage.setItem(r,JSON.stringify(s))}catch(c){console.warn("\u274C Kh\xF4ng th\u1EC3 update folderCache:",c)}try{let r=`recentViewed::${t}::${t}`,c=localStorage.getItem(r);if(c){let s=JSON.parse(c),l=!1;for(let d of s)d.path===o&&(d.isFavorite=n,l=!0);l&&localStorage.setItem(r,JSON.stringify(s))}}catch(r){console.warn("\u274C Kh\xF4ng th\u1EC3 update recentViewed:",r)}}var m={currentPath:"",allFolders:[]},w=0,S=24,M=0;function y(e="",t=0){let o=g(),n=u();m.currentPath=e,w=t,document.getElementById("loading-overlay")?.classList.remove("hidden");let i=document.getElementById("readerModeButton");i&&i.remove();let a=F(n,o,e);if(a&&a.data){B(a.data),document.getElementById("loading-overlay")?.classList.add("hidden");return}fetch(`/api/manga/folder-cache?mode=path&key=${encodeURIComponent(n)}&root=${encodeURIComponent(o)}&path=${encodeURIComponent(e)}`).then(r=>r.json()).then(r=>{R(n,o,e,r),B(r)}).catch(r=>{console.error("\u274C L\u1ED7i khi load folder:",r),v("\u{1F6AB} L\u1ED7i khi t\u1EA3i th\u01B0 m\u1EE5c, vui l\xF2ng th\u1EED l\u1EA1i!")}).finally(()=>{document.getElementById("loading-overlay")?.classList.add("hidden")})}function B(e){console.log("\u{1F4E6} Data render:",e);let t=document.getElementById("app");if(t.innerHTML="",e.type==="folder"){if(m.allFolders=[],e.images&&e.images.length>0){let a=m.currentPath.split("/"),r=a[a.length-1]||"Xem \u1EA3nh";m.allFolders.push({name:r,path:m.currentPath+"/__self__",thumbnail:e.images[0],isSelfReader:!0,images:e.images,hasImages:!0})}m.allFolders=m.allFolders.concat(e.folders),M=m.allFolders.length;let o=m.allFolders.slice(w*S,(w+1)*S),n=m.allFolders.slice((w+1)*S,(w+2)*S),i=[...o,...n];L(i),P(o),T(w,M,S)}else if(e.type==="reader"){document.getElementById("loading-overlay")?.classList.remove("hidden");let o=encodeURIComponent(m.currentPath);window.location.href=`/manga/reader.html?path=${o}`}}function P(e){let t=document.getElementById("app");t.innerHTML="";let o=document.createElement("section");o.className="folder-section grid";let n=document.createElement("div");n.className="folder-section-header";let i=document.createElement("h3");i.className="folder-section-title";let a=m.currentPath.split("/").filter(Boolean),r=a[a.length-1];i.textContent=a.length===0?"\u{1F4C2} Th\u01B0 m\u1EE5c":`\u{1F4C1} ${r}`,a.length>0&&(i.style.cursor="pointer",i.title="Click \u0111\u1EC3 quay v\u1EC1 th\u01B0 m\u1EE5c cha",i.onclick=()=>{let s=a.slice(0,-1).join("/");y(s)},i.style.maxWidth="100%",i.style.overflow="hidden",i.style.textOverflow="ellipsis",i.style.whiteSpace="nowrap"),n.appendChild(i),o.appendChild(n);let c=document.createElement("div");c.className="grid",e.forEach(s=>{let l=C(s,!0);c.appendChild(l)}),o.appendChild(c),t.appendChild(o)}function T(e,t,o,n,i=null){let a=Math.ceil(t/o),r=i||document.getElementById("app");if(!r)return;let c=document.createElement("div");c.className="reader-controls";let s=document.createElement("button");s.textContent="\u2B05 Trang tr\u01B0\u1EDBc",s.disabled=e<=0,s.onclick=()=>y(m.currentPath,e-1),c.appendChild(s);let l=document.createElement("form");l.style.display="inline-block",l.style.margin="0 10px",l.onsubmit=D=>{D.preventDefault();let b=parseInt(d.value)-1;!isNaN(b)&&b>=0&&y(m.currentPath,b)};let d=document.createElement("input");d.type="number",d.min=1,d.max=a,d.placeholder="Trang...",d.title=`T\u1ED5ng ${a} trang`,d.style.width="60px";let h=document.createElement("button");h.textContent="\u23E9",l.appendChild(d),l.appendChild(h),c.appendChild(l);let f=document.createElement("button");f.textContent="Trang sau \u27A1",f.disabled=e+1>=a,f.onclick=()=>y(m.currentPath,e+1),c.appendChild(f),r.appendChild(c);let k=document.createElement("div");k.textContent=`Trang ${e+1} / ${a}`,k.style.textAlign="center",k.style.marginTop="10px",r.appendChild(k)}function v(e){let t=document.getElementById("global-toast");t||(t=document.createElement("div"),t.id="global-toast",t.style.position="fixed",t.style.bottom="20px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.background="#333",t.style.color="white",t.style.padding="10px 20px",t.style.borderRadius="8px",t.style.zIndex="9999",t.style.fontSize="14px",document.body.appendChild(t)),t.textContent=e,t.style.display="block",setTimeout(()=>{t.style.display="none"},3e3)}var I="folderCache::";function g(){return localStorage.getItem("rootFolder")}function u(){return localStorage.getItem("sourceKey")}function N(e,t,o){if(!e)return null;let n=`${I}${e}`;return t&&(n+=`::${t}`),o&&(n+=`:${o}`),n}function F(e,t,o){let n=N(e,t,o),i=localStorage.getItem(n);if(!i)return null;try{let a=JSON.parse(i);return{data:a.data,timestamp:a.timestamp}}catch{return localStorage.removeItem(n),null}}function R(e,t,o,n){if(!e||t===null||t===void 0){let s=`\u26A0\uFE0F Kh\xF4ng cache \u0111\u01B0\u1EE3c do thi\u1EBFu th\xF4ng tin: sourceKey = ${e}, rootFolder = ${t}`;console.warn(s),v(s);return}if(!n||Array.isArray(n.folders)&&n.folders.length===0&&Array.isArray(n.images)&&n.images.length===0){console.warn("\u26A0\uFE0F D\u1EEF li\u1EC7u r\u1ED7ng, kh\xF4ng l\u01B0u cache:",o);return}let i=N(e,t,o),a=JSON.stringify({timestamp:Date.now(),data:n}),r=4*1024*1024+300,c=U();if(a.length>r){console.warn(`\u26A0\uFE0F Folder qu\xE1 l\u1EDBn, kh\xF4ng cache localStorage: ${o}`);return}c+a.length>r&&(size=r-a.length,size>r/2&&(size=r/2),K(size)),localStorage.setItem(i,a)}function U(){let e=0;for(let t in localStorage)if(t.startsWith(I)){let o=localStorage.getItem(t);e+=o?.length||0}return e}function K(e){let t=[];for(let n in localStorage)if(n.startsWith(I))try{let i=localStorage.getItem(n),a=JSON.parse(i);t.push({key:n,size:i.length,timestamp:a.timestamp||0})}catch{localStorage.removeItem(n)}t.sort((n,i)=>n.timestamp-i.timestamp);let o=0;for(let n of t)if(localStorage.removeItem(n.key),o+=n.size,o>=e)break;console.log(`\u{1F9F9} D\u1ECDn cache: \u0111\xE3 xo\xE1 ${o} byte`)}var x=[],p=0,E=20;function $(){let e=document.getElementById("app");e.innerHTML="";let t=document.createElement("section");t.className="folder-section grid";let o=document.createElement("div");o.className="folder-section-header";let n=document.createElement("h3");n.className="folder-section-title",n.textContent=`\u2764\uFE0F Truy\u1EC7n y\xEAu th\xEDch (${x.length})`,o.appendChild(n),t.appendChild(o);let i=document.createElement("div");i.className="grid",x.slice(p*E,(p+1)*E).forEach(r=>{let c=C(r,!0);i.appendChild(c)}),t.appendChild(i),e.appendChild(t),H()}function H(){let e=document.getElementById("app"),t=Math.ceil(x.length/E),o=document.createElement("div");o.className="reader-controls";let n=document.createElement("button");n.textContent="\u2B05 Trang tr\u01B0\u1EDBc",n.disabled=p<=0,n.onclick=()=>{p--,$()},o.appendChild(n);let i=document.createElement("div");i.textContent=`Trang ${p+1} / ${t}`,o.appendChild(i);let a=document.createElement("button");a.textContent="Trang sau \u27A1",a.disabled=p+1>=t,a.onclick=()=>{p++,$()},o.appendChild(a),e.appendChild(o)}async function V(){let e=g(),t=u();if(!e||!t)return v("\u274C Thi\u1EBFu root ho\u1EB7c sourceKey");document.getElementById("loading-overlay")?.classList.remove("hidden");try{x=await(await fetch(`/api/manga/favorite?key=${encodeURIComponent(t)}&root=${encodeURIComponent(e)}`)).json(),p=0,$()}catch(o){v("\u274C L\u1ED7i khi t\u1EA3i danh s\xE1ch y\xEAu th\xEDch"),console.error("favorite.js error:",o)}finally{document.getElementById("loading-overlay")?.classList.add("hidden")}}window.addEventListener("DOMContentLoaded",V);window.loadFolder=y;})();
