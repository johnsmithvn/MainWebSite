(()=>{async function Ce(){let e=document.getElementById("floatingSearchInput")?.value.trim().toLowerCase(),t=document.getElementById("search-dropdown"),o=k(),n=f();if(!e){t.classList.add("hidden"),t.innerHTML="";return}t.classList.remove("hidden"),t.innerHTML='<div id="search-loader">\u{1F50D} \u0110ang t\xECm ki\u1EBFm...</div>';try{let a=await(await fetch(`/api/manga/folder-cache?mode=search&key=${encodeURIComponent(n)}&root=${encodeURIComponent(o)}&q=${encodeURIComponent(e)}`)).json();if(t.innerHTML="",a.length===0){t.innerHTML='<div id="search-loader">\u274C Kh\xF4ng t\xECm th\u1EA5y k\u1EBFt qu\u1EA3</div>';return}a.forEach(l=>{let d=document.createElement("div");d.className="search-item",d.innerHTML=`
        <img src="${l.thumbnail}" class="search-thumb" alt="thumb">
        <div class="search-title">${l.name}</div>
      `,d.onclick=()=>{t.classList.add("hidden"),window.location.pathname.includes("reader.html")?window.location.href=`/manga/index.html?path=${encodeURIComponent(l.path)}`:window.loadFolder?.(l.path)},t.appendChild(d)})}catch(i){t.innerHTML='<div id="search-loader">\u26A0\uFE0F L\u1ED7i khi t\xECm ki\u1EBFm</div>',console.error("\u274C L\u1ED7i t\xECm ki\u1EBFm:",i)}}function te(){let e=document.getElementById("floating-search");e?.classList.toggle("active");let t=document.getElementById("floatingSearchInput");e?.classList.contains("active")?t?.focus():(t.value="",Ce())}function z(e,t="random-timestamp"){let o=document.getElementById(t);if(!o)return;let n=Math.floor((Date.now()-e)/6e4);window.innerWidth<=480?o.textContent=`\u{1F3B2} ${n===0?"now":`${n}m`}`:o.textContent=`\u{1F3B2} Random ${n===0?"v\u1EEBa xong":`${n} ph\xFAt tr\u01B0\u1EDBc`}`}function j(e=[]){let t=window.location.pathname.includes("movie"),o=t?e.filter(n=>n.type==="video"||n.type==="file"):e.filter(n=>!n.type||n.type!=="video"&&n.type!=="file");I({title:t?"\u{1F553} V\u1EEBa xem":"\u{1F558} M\u1EDBi \u0111\u1ECDc",folders:o,targetId:"section-recent"})}function N(e,t){let o=document.createElement("button");return o.textContent=e,o.onclick=t,o}function L(e){return async(...t)=>{let o=document.getElementById("loading-overlay");o?.classList.remove("hidden"),await new Promise(n=>requestAnimationFrame(()=>setTimeout(n,0)));try{await e(...t)}catch(n){console.error("\u274C withLoading error:",n)}finally{o?.classList.add("hidden")}}}function p(e){let t=document.getElementById("global-toast");t||(t=document.createElement("div"),t.id="global-toast",t.style.position="fixed",t.style.bottom="20px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.background="#333",t.style.color="white",t.style.padding="10px 20px",t.style.borderRadius="8px",t.style.zIndex="9999",t.style.fontSize="14px",document.body.appendChild(t)),t.textContent=e,t.style.display="block",setTimeout(()=>{t.style.display="none"},3e3)}function x(e,t={}){let o=document.getElementById("global-confirm");return o||(o=document.createElement("div"),o.id="global-confirm",o.className="modal-overlay hidden",o.innerHTML=`
      <div class="modal-box">
        <p id="confirm-text"></p>
        <div class="buttons">
          <button class="ok">OK</button>
          <button class="cancel">Hu\u1EF7</button>
        </div>
      </div>
    `,document.body.appendChild(o)),o.querySelector("#confirm-text").textContent=e,o.classList.remove("hidden"),new Promise(n=>{let i=o.querySelector("button.ok"),a=o.querySelector("button.cancel"),l=()=>{o.classList.add("hidden"),i.removeEventListener("click",d),a.removeEventListener("click",r)},d=()=>{l(),t.loading&&document.getElementById("loading-overlay")?.classList.remove("hidden"),n(!0)},r=()=>{l(),n(!1)};i.addEventListener("click",d),a.addEventListener("click",r)})}function ne(){let e=document.getElementById("sidebar-menu");if(!e)return;e.innerHTML="";let t=f();e.appendChild(N("\u{1F3BC} \u0110\u1ED5i Music Folder",()=>{localStorage.removeItem("rootFolder"),window.location.href="/home.html"})),e.appendChild(N("\u{1F5D1} Xo\xE1 Music DB",L(async()=>{if(await x("B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n xo\xE1 DB music?",{loading:!0}))try{let i=await(await fetch(`/api/music/reset-cache-music?key=${t}&mode=delete`,{method:"DELETE"})).json();p(i.message||"\u2705 \u0110\xE3 xo\xE1 DB")}catch{p("\u274C L\u1ED7i khi g\u1ECDi API xo\xE1 DB")}}))),e.appendChild(N("\u{1F504} Reset DB (Xo\xE1 + Scan)",L(async()=>{if(await x("Reset DB music v\xE0 scan l\u1EA1i?",{}))try{let i=await(await fetch(`/api/music/reset-cache-music?key=${t}&mode=reset`,{method:"DELETE"})).json();p(i.message||"\u2705 Reset DB xong"),window.location.reload()}catch(n){console.error(n),p("\u274C L\u1ED7i reset DB")}}))),e.appendChild(N("\u{1F4E6} Qu\xE9t th\u01B0 m\u1EE5c m\u1EDBi",L(async()=>{if(await x("Qu\xE9t folder m\u1EDBi (kh\xF4ng xo\xE1 DB)?",{}))try{let i=await(await fetch("/api/music/scan-music",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:t})})).json();p(`\u2705 Scan xong:
Inserted ${i.stats.inserted}, Updated ${i.stats.updated}, Skipped ${i.stats.skipped}`)}catch{p("\u274C L\u1ED7i khi qu\xE9t folder")}}))),e.appendChild(N("\u{1F9FC} Xo\xE1 cache folder",L(async()=>{if(!await x("Xo\xE1 to\xE0n b\u1ED9 cache folder music?"))return;let n=0;Object.keys(localStorage).forEach(i=>{i.startsWith(`musicCache::${t}::`)&&(localStorage.removeItem(i),n++)}),p(`\u2705 \u0110\xE3 xo\xE1 ${n} cache folder`)})))}async function oe(){let e=document.getElementById("floatingSearchInput")?.value.trim().toLowerCase(),t=document.getElementById("search-dropdown"),o=f(),n=document.getElementById("search-type-select")?.value||"audio";if(!e){t.classList.add("hidden"),t.innerHTML="";return}t.classList.remove("hidden"),t.innerHTML='<div id="search-loader">\u{1F50D} \u0110ang t\xECm nh\u1EA1c...</div>';try{let a=await(await fetch(`/api/music/audio-cache?mode=search&key=${encodeURIComponent(o)}&q=${encodeURIComponent(e)}&type=${encodeURIComponent(n)}`)).json();if(t.innerHTML="",!a.folders||a.folders.length===0){t.innerHTML='<div id="search-loader">\u274C Kh\xF4ng t\xECm th\u1EA5y b\xE0i h\xE1t n\xE0o</div>';return}a.folders.forEach(l=>{let d=document.createElement("div");d.className="search-item";let r=l.type==="audio"||l.type==="file",s=E(l,"music");d.innerHTML=`
        <img src="${s}" class="search-thumb" alt="thumb">
        <div class="search-title">${l.name}</div>
      `,d.onclick=()=>{t.classList.add("hidden"),r?window.location.href=`/music/player.html?file=${encodeURIComponent(l.path)}`:window.location.href=`/music/index.html?path=${encodeURIComponent(l.path)}`},t.appendChild(d)})}catch(i){console.error("\u274C L\u1ED7i t\xECm ki\u1EBFm nh\u1EA1c:",i),t.innerHTML='<div id="search-loader">\u26A0\uFE0F L\u1ED7i khi t\xECm ki\u1EBFm</div>'}}function ae(e,t="",o="OK",n="H\u1EE7y"){return new Promise(i=>{let a=document.createElement("div");a.className="popup-overlay",a.style.zIndex="99999",a.innerHTML=`
      <div class="popup-confirm">
        <div class="popup-message">${e}</div>
        <input class="popup-input" type="text" placeholder="${t}" autofocus />
        <div class="popup-actions">
          <button class="popup-ok">${o}</button>
          <button class="popup-cancel">${n}</button>
        </div>
      </div>
    `,document.body.appendChild(a);let l=a.querySelector(".popup-input"),d=a.querySelector(".popup-ok"),r=a.querySelector(".popup-cancel");d.onclick=()=>{let s=l.value.trim();a.remove(),i(s||null)},r.onclick=()=>{a.remove(),i(null)},l.onkeydown=s=>{s.key==="Enter"&&d.click(),s.key==="Escape"&&r.click()},l.focus()})}function E(e,t="movie"){let o="/video/",n="/default/video-thumb.png",i="/default/folder-thumb.png";t==="music"?(o="/audio/",n="/default/music-thumb.png",i="/default/folder-thumb.png"):(t==="manga"||t==="comic")&&(o="/manga/",n="/default/manga-thumb.png",i="/default/folder-thumb.png");let a;return e.type==="folder"?a=e.path||"":a=e.path?.split("/").slice(0,-1).join("/")||"",e.thumbnail?e.thumbnail.startsWith(o)||e.thumbnail.startsWith("http")||e.thumbnail.startsWith("/default/")?e.thumbnail:(a&&e.thumbnail.startsWith(a+"/")&&(e.thumbnail=e.thumbnail.slice(a.length+1)),`${o}${a?a+"/":""}${e.thumbnail.replace(/\\/g,"/")}`):t==="music"?e.type==="audio"||e.type==="file"?n:i:t==="manga"||t==="comic"?e.type==="folder"?i:n:e.type==="video"||e.type==="file"?n:i}function Q(e=[]){let t=e.filter(o=>o.type==="audio"||o.type==="file");I({title:"\u{1F558} Nh\u1EA1c v\u1EEBa nghe",folders:t,targetId:"section-recent-music"})}function k(){return localStorage.getItem("rootFolder")}function f(){return localStorage.getItem("sourceKey")}function ie(){return`recentViewed::${k()}::${k()}`}function ce(){return`recentViewedVideo::${f()}`}var Se="musicCache::";function re(e,t){return`${Se}${e}::${t||""}`}function se(e,t){let o=re(e,t),n=localStorage.getItem(o);if(!n)return null;try{let i=JSON.parse(n);return{data:i.data,timestamp:i.timestamp}}catch{return localStorage.removeItem(o),null}}function le(e,t,o){let n=re(e,t),i=JSON.stringify({timestamp:Date.now(),data:o});localStorage.setItem(n,i)}function U(){return`recentViewedMusic::${f()}`}function X(e,t=!1){let o=document.createElement("div");o.className="folder-card";let n=e.thumbnail?`<img src="${e.thumbnail}" alt="${e.name}" loading="lazy">`:'<div class="folder-thumb-placeholder">Kh\xF4ng c\xF3 \u1EA3nh</div>',i=e.name;e.name==="__self__"&&(i=e.path.split("/").at(-2)||"\u1EA2nh"),o.innerHTML=`
    <div class="folder-thumb">
      ${n}
      ${t&&e.count?`<div class="folder-views">\u{1F441} ${e.count}</div>`:""}
      <div class="folder-fav ${e.isFavorite?"active":""}" title="${e.isFavorite?"B\u1ECF y\xEAu th\xEDch":"Th\xEAm y\xEAu th\xEDch"}">${e.isFavorite?"\u2764\uFE0F":"\u{1F90D}"}</div>
    </div>
    <div class="folder-title">${i}</div>
  `,o.onclick=l=>{if(!l.target.classList.contains("folder-fav"))if(e.isSelfReader&&e.images){let d=encodeURIComponent(e.path);window.location.href=`/manga/reader.html?path=${d}`}else window.loadFolder?.(e.path)};let a=o.querySelector(".folder-fav");return a.onclick=async l=>{l.stopPropagation();let d=f(),r=k(),s=!e.isFavorite;e.isFavorite=s,a.classList.toggle("active",s),a.textContent=s?"\u2764\uFE0F":"\u{1F90D}",a.title=s?"B\u1ECF y\xEAu th\xEDch":"Th\xEAm y\xEAu th\xEDch";try{let c=d?.startsWith("V_");await fetch(c?"/api/movie/favorite-movie":"/api/manga/favorite",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dbkey:d,path:e.path,value:s})}),xe(d,r,e.path,s)}catch(c){console.warn("\u274C Kh\xF4ng th\u1EC3 l\u01B0u y\xEAu th\xEDch:",c)}},o}function xe(e,t,o,n){if(e?.startsWith("V_")){let l=`movieCache::${e}::`;for(let d in localStorage)if(d.startsWith(l))try{let r=localStorage.getItem(d),s=JSON.parse(r),c=!1;if(Array.isArray(s.data))for(let m of s.data)m.path===o&&(m.isFavorite=n,c=!0);c&&localStorage.setItem(d,JSON.stringify(s))}catch(r){console.warn("\u274C Kh\xF4ng th\u1EC3 update movieCache:",r)}["randomFolders","randomVideos"].forEach(d=>{let r=`${d}-${e}`,s=localStorage.getItem(r);if(s)try{let c=JSON.parse(s),m=!1;if(Array.isArray(c.data))for(let y of c.data)y.path===o&&(y.isFavorite=n,m=!0);m&&localStorage.setItem(r,JSON.stringify(c))}catch(c){console.warn("\u274C Kh\xF4ng th\u1EC3 update random cache:",c)}});return}let a=`folderCache::${e}::${t}`;for(let l in localStorage)if(l.startsWith(a))try{let d=localStorage.getItem(l),r=JSON.parse(d),s=!1;if(r.data&&r.data.folders)for(let c of r.data.folders)c.path===o&&(c.isFavorite=n,s=!0);r.data?.images&&o.endsWith("/__self__")&&(r.data.isFavorite=n,s=!0),s&&localStorage.setItem(l,JSON.stringify(r))}catch(d){console.warn("\u274C Kh\xF4ng th\u1EC3 update folderCache:",d)}try{let l=`recentViewed::${t}::${t}`,d=localStorage.getItem(l);if(d){let r=JSON.parse(d),s=!1;for(let c of r)c.path===o&&(c.isFavorite=n,s=!0);s&&localStorage.setItem(l,JSON.stringify(r))}}catch(l){console.warn("\u274C Kh\xF4ng th\u1EC3 update recentViewed:",l)}}function I({title:e,folders:t,showViews:o=!1,targetId:n,onRefresh:i=null}){let a=document.createElement("section");a.className="folder-section slider";let l=document.createElement("div");l.className="folder-section-header";let d=document.createElement("div");d.className="slider-left";let r=document.createElement("h3");r.className="folder-section-title",r.textContent=e,d.appendChild(r),l.appendChild(d);let s=e.toLowerCase().includes("v\u1EEBa xem")||e.toLowerCase().includes("v\u1EEBa nghe")||e.toLowerCase().includes("m\u1EDBi \u0111\u1ECDc")||e.toLowerCase().includes("nh\u1EA1c v\u1EEBa nghe");if(e.includes("ng\u1EABu nhi\xEAn")||s){let u=document.createElement("div");if(u.className="slider-right",e.includes("ng\u1EABu nhi\xEAn")){let h=document.createElement("button");h.id="refresh-random-btn",h.textContent="\u{1F504} Refresh",h.className="small-button",u.appendChild(h),h.onclick=()=>{typeof i=="function"&&i()};let v=document.createElement("span");v.className="random-timestamp",e.includes("Folder")?v.id="random-timestamp-folder":e.includes("Video")?v.id="random-timestamp-video":e.includes("B\xE0i h\xE1t")?v.id="random-timestamp-audio":v.id="random-timestamp",v.textContent="",u.appendChild(v)}if(s){let h=document.createElement("button");h.textContent="\u{1F5D1}\uFE0F Xo\xE1 t\u1EA5t c\u1EA3",h.className="small-button",h.onclick=()=>{let v,S;window.location.pathname.includes("movie")?(v=ce(),S=j):window.location.pathname.includes("music")?(v=U(),S=window.renderRecentViewedMusic||j):(v=ie(),S=j),localStorage.removeItem(v),S([])},u.appendChild(h)}l.appendChild(u)}a.appendChild(l);let c=document.createElement("div");c.style.position="relative";let m=document.createElement("div");m.className="slider-wrapper",m.style.scrollSnapType="x mandatory",m.style.overflowX="auto";let y=window.location.pathname.includes("movie");t.forEach(u=>{let h=window.location.pathname.includes("music"),v=window.location.pathname.includes("movie"),S=!h&&!v,J="movie";h?J="music":S&&(J="manga");let ve=E(u,J),we={...u,thumbnail:ve},A=X(we,o);A.style.scrollSnapAlign="start",m.appendChild(A);let D=encodeURIComponent(u.path),W=f();A.onclick=be=>{if(be.target.classList.contains("folder-fav"))return;if(u.isPlaylist){let _=f();window.location.href=`/music/player.html?playlist=${encodeURIComponent(u.path)}&key=${_}`;return}let q=window.location.pathname.includes("music"),ee=window.location.pathname.includes("movie");if(q&&(u.type==="audio"||u.type==="file")||ee&&(u.type==="video"||u.type==="file")){let _=q?"music/player":"movie/player";window.location.href=`/${_}.html?file=${D}&key=${W}`;return}q?window.location.href=`/music/index.html?path=${D}&key=${W}`:ee?window.location.href=`/movie/index.html?path=${D}&key=${W}`:u.isSelfReader&&u.images?window.location.href=`/manga/reader.html?path=${D}`:typeof window.loadFolder=="function"&&window.loadFolder(u.path)}}),c.appendChild(m);let g=window.innerWidth<=768,w=document.createElement("button"),b=document.createElement("button");w.className="nav-button prev-button",b.className="nav-button next-button",w.innerHTML="\u2190",b.innerHTML="\u2192",g||(c.appendChild(w),c.appendChild(b)),a.appendChild(c);let R=document.createElement("div");R.className="slider-pagination",a.appendChild(R);let V=n?document.getElementById(n):document.getElementById(e.includes("ng\u1EABu nhi\xEAn")?"section-random":e.includes("Xem nhi\u1EC1u")?"section-topview":"section-recent");V&&(V.innerHTML="",V.appendChild(a));let O=m.querySelector(".folder-card")?.offsetWidth+16||200,G=Math.ceil(t.length/5);w.onclick=()=>m.scrollBy({left:-O,behavior:"smooth"}),b.onclick=()=>m.scrollBy({left:O,behavior:"smooth"});for(let u=0;u<G;u++){let h=document.createElement("span");h.className="pagination-dot",h.style.cursor="pointer",u===0&&h.classList.add("active"),h.onclick=()=>m.scrollTo({left:u*O*5,behavior:"smooth"}),R.appendChild(h)}m.addEventListener("scroll",()=>{let u=m.scrollLeft/(m.scrollWidth-m.clientWidth),h=Math.round(u*(G-1));R.querySelectorAll(".pagination-dot").forEach((v,S)=>{v.classList.toggle("active",S===h)})});let P=0,B=null,ge=()=>{let u=m.scrollWidth-m.clientWidth;P+=O*5,P>u&&(P=0),m.scrollTo({left:P,behavior:"smooth"})},Y=()=>{!g&&!B&&(B=setInterval(ge,2e4))},Z=()=>{B&&clearInterval(B),B=null};new IntersectionObserver(u=>{u[0].isIntersecting?Y():Z()},{threshold:.5}).observe(a),m.addEventListener("mouseenter",Z),m.addEventListener("mouseleave",Y)}function de(){["randomFolderSection","randomVideoSection"].forEach(e=>{if(!document.getElementById(e)){let t=document.createElement("section");t.id=e,document.body.prepend(t)}})}function me(e="movie"){let t=f(),o=e==="music",n=o?"/api/music/audio-cache":"/api/movie/video-cache";K("folder",t,"randomFolderSection",o?"\u{1F3B2} Th\u01B0 m\u1EE5c nh\u1EA1c ng\u1EABu nhi\xEAn":"\u{1F3B2} Folder ng\u1EABu nhi\xEAn",!1,n,"random-timestamp-folder"),K("file",t,o?"randomAudioSection":"randomVideoSection",o?"\u{1F3B5} B\xE0i h\xE1t ng\u1EABu nhi\xEAn":"\u{1F3AC} Video ng\u1EABu nhi\xEAn",!1,n,o?"random-timestamp-audio":"random-timestamp-video")}async function K(e,t,o,n,i=!1,a,l){if(!a){let r=window.location.pathname;r.includes("music")?a="/api/music/audio-cache":r.includes("movie")?a="/api/movie/video-cache":r.includes("manga")||r.includes("comic")||r.includes("reader")?a="/api/manga/folder-cache":a="/api/movie/video-cache"}if(!t)return;let d=`${e==="file"?a.includes("music")?"randomAudios":"randomVideos":"randomFolders"}-${t}`;if(l=l||(e==="file"?a.includes("music")?"random-timestamp-audio":"random-timestamp-video":"random-timestamp-folder"),!i){let r=localStorage.getItem(d);if(r)try{let s=JSON.parse(r);if(!(Date.now()-s.timestamp>30*60*1e3)){I({title:n,folders:s.data,targetId:o,onRefresh:()=>K(e,t,o,n,!0,a,l)}),document.getElementById(l)&&z(s.timestamp,l);return}}catch{}}try{let s=await(await fetch(`${a}?mode=random&type=${e}&key=${t}`)).json(),c=Array.isArray(s)?s:s.folders,m=Date.now();localStorage.setItem(d,JSON.stringify({data:c,timestamp:m})),I({title:n,folders:c,targetId:o,onRefresh:()=>K(e,t,o,n,!0,a,l)}),document.getElementById(l)&&z(m,l)}catch(r){console.error("\u274C L\u1ED7i random slider:",r)}}async function F(e,t,o){let n=document.getElementById("playlist-popup");n||(n=document.createElement("div"),n.id="playlist-popup",n.className="playlist-popup",document.body.appendChild(n));let i=f(),a=[];try{a=await(await fetch(`/api/music/playlists?key=${i}`)).json()}catch{p("\u274C L\u1ED7i t\u1EA3i danh s\xE1ch playlist")}n.innerHTML=`
  <div class="popup-title" style="display:flex;align-items:center;justify-content:space-between;gap:4px;">
    <span class="popup-title-text" title="${t}" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:215px;display:inline-block;">
      Add "${t}"
    </span>
    <button id="playlist-close-btn" title="\u0110\xF3ng" style="
      background:none;
      border:none;
      font-size:1.3em;
      line-height:1;
      cursor:pointer;
      color:#999;
      margin-left:10px;
      padding:0 6px 0 6px;
      flex-shrink:0;
      ">\u2716</button>
  </div>
  <div class="playlist-list-scroll"></div>
`,document.getElementById("playlist-close-btn")?.addEventListener("click",()=>{n.remove()});let l=n.querySelector(".playlist-list-scroll");(await Promise.all(a.map(async c=>{let g=(await(await fetch(`/api/music/playlist/${c.id}?key=${i}`)).json()).tracks?.some(w=>w.path===e);return{...c,contains:g}}))).forEach(c=>{let m=document.createElement("div");m.className="playlist-row";let y=document.createElement("button");y.className="playlist-option"+(c.contains?" bold":""),y.innerHTML=c.contains?`\u2705 ${c.name}`:c.name,y.style.flex="1",y.style.textAlign="left",y.onclick=async()=>{c.contains?(await fetch("/api/music/playlist/remove",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:i,playlistId:c.id,path:e})}),p("\u274C \u0110\xE3 xo\xE1 kh\u1ECFi playlist")):(await fetch("/api/music/playlist/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:i,playlistId:c.id,path:e})}),p("\u2705 \u0110\xE3 th\xEAm v\xE0o playlist")),F(e,t,o)};let g=document.createElement("button");g.textContent="\u{1F5D1}\uFE0F",g.className="playlist-delete-btn",g.title="Xo\xE1 playlist n\xE0y",g.style.marginLeft="6px",g.onclick=async w=>{w.stopPropagation(),await x(`Xo\xE1 playlist "${c.name}"?`)&&(await fetch("/api/music/playlist",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:i,id:c.id})}),p("\u{1F5D1}\uFE0F \u0110\xE3 xo\xE1 playlist"),F(e,t,o))},m.appendChild(y),m.appendChild(g),m.style.display="flex",m.style.alignItems="center",m.style.gap="0",l.appendChild(m)});let r=document.createElement("button");r.className="playlist-option bold playlist-add-btn",r.textContent="\u2795 T\u1EA1o playlist m\u1EDBi...",r.onclick=async()=>{let c=await ae("Nh\u1EADp t\xEAn playlist m\u1EDBi","T\xEAn playlist");if(!c)return;(await(await fetch("/api/music/playlist",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:i,name:c})})).json())?.id&&(p("\u2705 T\u1EA1o playlist th\xE0nh c\xF4ng!"),F(e,t,o))},n.appendChild(r);let s=window.innerWidth<=480;n.style.position="fixed",n.style.left="50%",n.style.top="50%",n.style.transform="translate(-50%, -50%)",n.style.width=s?"min(96vw, 400px)":"340px",n.style.maxWidth=s?"96vw":"340px",n.style.maxHeight=s?"87vh":"70vh",setTimeout(()=>{function c(m){n.contains(m.target)||(n.remove(),document.removeEventListener("click",c))}document.addEventListener("click",c)},0)}function ue(e){let t=document.createElement("div");t.className="music-card";let o=e.thumbnail;(!o||o==="null"||o==="undefined")&&(o=e.type==="folder"?"/default/folder-thumb.png":"/default/music-thumb.png");let i=document.createElement("img");i.className="music-thumb",i.src=o;let a=document.createElement("div");a.className="music-info";let l=document.createElement("div");l.className="music-title",l.textContent=e.name,t.title=e.name;let d=document.createElement("div");if(d.className="music-sub",e.type==="audio"||e.type==="file"){let s=e.path?.split(".").pop()?.toLowerCase();d.textContent=`\u{1F3A7} .${s||"audio"}`}else d.textContent="\u{1F4C1} Th\u01B0 m\u1EE5c";if(a.appendChild(l),a.appendChild(d),t.appendChild(i),t.appendChild(a),e.type==="audio"||e.type==="file"){let s=document.createElement("button");s.textContent="+",s.className="card-menu-btn",s.addEventListener("click",c=>{c.stopPropagation(),c.preventDefault(),F(e.path,e.name,c.target)}),t.appendChild(s)}let r=document.createElement("div");return r.className="folder-fav"+(e.isFavorite?" active":""),r.title=e.isFavorite?"B\u1ECF y\xEAu th\xEDch":"Th\xEAm y\xEAu th\xEDch",r.textContent=e.isFavorite?"\u2764\uFE0F":"\u{1F90D}",r.onclick=async s=>{s.stopPropagation();let c=!e.isFavorite;e.isFavorite=c,r.classList.toggle("active",c),r.textContent=c?"\u2764\uFE0F":"\u{1F90D}",r.title=c?"B\u1ECF y\xEAu th\xEDch":"Th\xEAm y\xEAu th\xEDch";try{await fetch("/api/music/favorite",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dbkey:f(),path:e.path,value:c})})}catch(m){console.warn("\u274C L\u1ED7i khi toggle favorite:",m)}},t.appendChild(r),t.addEventListener("click",s=>{if(s.target.closest(".card-menu-btn"))return;let c=encodeURIComponent(e.path),m=f();e.type==="audio"||e.type==="file"?window.location.href=`/music/player.html?file=${c}&key=${m}`:window.location.href=`/music/index.html?path=${c}`}),t}window.addEventListener("DOMContentLoaded",()=>{let e=ke();T(e),ne(),de(),me("music"),ye(),Ee(),Ie(),document.getElementById("floatingSearchInput")?.addEventListener("input",oe),document.getElementById("searchToggle")?.addEventListener("click",te),document.getElementById("sidebarToggle")?.addEventListener("click",()=>{document.getElementById("sidebar-menu")?.classList.toggle("active")}),window.renderRecentViewedMusic=Q});function ke(){return new URLSearchParams(window.location.search).get("path")||""}var M=0,H=20,$=[],C="";function he(e){return e.slice(M*H,(M+1)*H)}function T(e="",t=0){let o=f();if(!o){alert("Ch\u01B0a ch\u1ECDn ngu\u1ED3n nh\u1EA1c!"),window.location.href="/home.html";return}if(e==="")ye();else{let a=document.getElementById("section-playlists");a&&(a.innerHTML="")}C=e,M=t;let n=se(o,e);if(n&&Date.now()-n.timestamp<6*60*60*1e3){$=n.data||[],pe(he($),e),fe(M,$.length,H);return}let i=new URLSearchParams;i.set("key",o),e&&i.set("path",e),fetch("/api/music/music-folder?"+i.toString()).then(a=>a.json()).then(a=>{$=a.folders||[],le(o,e,$),pe(he($),e),fe(M,$.length,H)}).catch(a=>{console.error("\u274C Failed to load music folder:",a),p("\u{1F6AB} L\u1ED7i t\u1EA3i th\u01B0 m\u1EE5c nh\u1EA1c!")})}function pe(e){let t=document.getElementById("music-app");t.innerHTML="";let o=C?C.split("/").filter(Boolean):[],n=document.createElement("h2");if(n.className="folder-section-title",o.length===0)n.textContent="\u{1F4C2} Danh s\xE1ch nh\u1EA1c";else{let a=o.at(-1);n.textContent="\u{1F4C1} "+a,n.title=a,n.style.cursor="pointer",n.onclick=()=>{let l=o.slice(0,-1).join("/");T(l)}}t.appendChild(n);let i=document.createElement("div");i.className="music-grid",e.forEach(a=>{let l=E(a,"music"),d=ue({...a,thumbnail:l});i.appendChild(d)}),t.appendChild(i)}function Ee(){let e=localStorage.getItem(U());if(e){let t=JSON.parse(e);Q(t)}}function Ie(){let e=document.getElementById("extract-thumbnail-btn");e&&(e.onclick=L(async()=>{if(!await x("Extract l\u1EA1i thumbnail nh\u1EA1c cho to\xE0n b\u1ED9 folder hi\u1EC7n t\u1EA1i?"))return;let o=f();if(!o){p("\u274C Kh\xF4ng x\xE1c \u0111\u1ECBnh \u0111\u01B0\u1EE3c ngu\u1ED3n nh\u1EA1c!");return}let n=new URLSearchParams;o&&n.set("key",o),C&&n.set("path",C);try{let d=((await(await fetch("/api/music/music-folder?"+n.toString())).json()).folders||[]).filter(r=>r.type==="audio");if(d.length===0){p("\u{1F605} Kh\xF4ng c\xF3 b\xE0i h\xE1t n\xE0o \u0111\u1EC3 extract thumbnail.");return}p("\u23F3 \u0110ang extract thumbnail...");for(let r of d){let c=await(await fetch("/api/music/extract-thumbnail",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:o,file:r.path})})).json()}p("\u2705 \u0110\xE3 extract thumbnail xong!"),T(C,M)}catch(i){p("\u274C L\u1ED7i extract thumbnail!"),console.error(i)}}))}function fe(e,t,o){let n=Math.ceil(t/o),i=document.getElementById("music-app"),a=i.querySelector(".reader-controls");a&&a.remove();let l=i.querySelector(".music-pagination-info");l&&l.remove();let d=document.createElement("div");d.className="reader-controls";let r=document.createElement("button");r.textContent="\u2B05 Trang tr\u01B0\u1EDBc",r.disabled=e<=0,r.onclick=()=>T(C,e-1),d.appendChild(r);let s=document.createElement("form");s.style.display="inline-block",s.style.margin="0 10px",s.onsubmit=w=>{w.preventDefault();let b=parseInt(c.value)-1;!isNaN(b)&&b>=0&&T(C,b)};let c=document.createElement("input");c.type="number",c.min=1,c.max=n,c.placeholder="Trang...",c.style.width="60px";let m=document.createElement("button");m.textContent="\u23E9",s.appendChild(c),s.appendChild(m),d.appendChild(s);let y=document.createElement("button");y.textContent="Trang sau \u27A1",y.disabled=e+1>=n,y.onclick=()=>T(C,e+1),d.appendChild(y),i.appendChild(d);let g=document.createElement("div");g.textContent=`Trang ${e+1} / ${n}`,g.className="music-pagination-info",g.style.textAlign="center",g.style.marginTop="10px",i.appendChild(g)}async function ye(){let e=f();if(!e)return;let t=document.getElementById("section-playlists");if(t){t.innerHTML="<p>\u23F3 \u0110ang t\u1EA3i playlist...</p>";try{let n=await(await fetch(`/api/music/playlists?key=${e}`)).json();if(!Array.isArray(n)||n.length===0){t.innerHTML="<p>\u{1F605} Ch\u01B0a c\xF3 playlist n\xE0o</p>";return}let i=await Promise.all(n.map(async a=>{if(a.thumbnail)return{...a,path:a.id.toString(),thumbnail:E({thumbnail:a.thumbnail,path:""},"music"),isPlaylist:!0,type:"folder"};try{let r=(await(await fetch(`/api/music/playlist/${a.id}?key=${e}`)).json()).tracks?.[0],s=r?E(r,"music"):"/default/folder-thumb.png";return{...a,path:a.id.toString(),thumbnail:s,isPlaylist:!0,type:"folder"}}catch{return{...a,path:a.id.toString(),thumbnail:"/default/folder-thumb.png",isPlaylist:!0,type:"folder"}}}));I({title:"\u{1F3B6} Playlist",folders:i,targetId:"section-playlists"})}catch(o){console.error("loadPlaylistSlider error",o),t.innerHTML="<p>\u274C L\u1ED7i t\u1EA3i playlist</p>"}}}})();
