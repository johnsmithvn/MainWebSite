(()=>{function te(e,t=!1){let n=document.createElement("div");n.className="folder-card";let o=e.thumbnail?`<img src="${e.thumbnail}" alt="${e.name}" loading="lazy">`:'<div class="folder-thumb-placeholder">Kh\xF4ng c\xF3 \u1EA3nh</div>',c=e.name;e.name==="__self__"&&(c=e.path.split("/").at(-2)||"\u1EA2nh"),n.innerHTML=`
    <div class="folder-thumb">
      ${o}
      ${t&&e.count?`<div class="folder-views">\u{1F441} ${e.count}</div>`:""}
      <div class="folder-fav ${e.isFavorite?"active":""}" title="${e.isFavorite?"B\u1ECF y\xEAu th\xEDch":"Th\xEAm y\xEAu th\xEDch"}">${e.isFavorite?"\u2764\uFE0F":"\u{1F90D}"}</div>
    </div>
    <div class="folder-title">${c}</div>
  `,n.onclick=r=>{if(!r.target.classList.contains("folder-fav"))if(e.isSelfReader&&e.images){let s=encodeURIComponent(e.path);window.location.href=`/manga/reader.html?path=${s}`}else window.loadFolder?.(e.path)};let a=n.querySelector(".folder-fav");return a.onclick=async r=>{r.stopPropagation();let s=g(),l=B(),d=!e.isFavorite;e.isFavorite=d,a.classList.toggle("active",d),a.textContent=d?"\u2764\uFE0F":"\u{1F90D}",a.title=d?"B\u1ECF y\xEAu th\xEDch":"Th\xEAm y\xEAu th\xEDch";try{let i=s?.startsWith("V_");await fetch(i?"/api/movie/favorite-movie":"/api/manga/favorite",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dbkey:s,path:e.path,value:d})}),Te(s,l,e.path,d)}catch(i){console.warn("\u274C Kh\xF4ng th\u1EC3 l\u01B0u y\xEAu th\xEDch:",i)}},n}function Te(e,t,n,o){if(e?.startsWith("V_")){let r=`movieCache::${e}::`;for(let s in localStorage)if(s.startsWith(r))try{let l=localStorage.getItem(s),d=JSON.parse(l),i=!1;if(Array.isArray(d.data))for(let m of d.data)m.path===n&&(m.isFavorite=o,i=!0);i&&localStorage.setItem(s,JSON.stringify(d))}catch(l){console.warn("\u274C Kh\xF4ng th\u1EC3 update movieCache:",l)}["randomFolders","randomVideos"].forEach(s=>{let l=`${s}-${e}`,d=localStorage.getItem(l);if(d)try{let i=JSON.parse(d),m=!1;if(Array.isArray(i.data))for(let v of i.data)v.path===n&&(v.isFavorite=o,m=!0);m&&localStorage.setItem(l,JSON.stringify(i))}catch(i){console.warn("\u274C Kh\xF4ng th\u1EC3 update random cache:",i)}});return}let a=`folderCache::${e}::${t}`;for(let r in localStorage)if(r.startsWith(a))try{let s=localStorage.getItem(r),l=JSON.parse(s),d=!1;if(l.data&&l.data.folders)for(let i of l.data.folders)i.path===n&&(i.isFavorite=o,d=!0);l.data?.images&&n.endsWith("/__self__")&&(l.data.isFavorite=o,d=!0),d&&localStorage.setItem(r,JSON.stringify(l))}catch(s){console.warn("\u274C Kh\xF4ng th\u1EC3 update folderCache:",s)}try{let r=`recentViewed::${t}::${t}`,s=localStorage.getItem(r);if(s){let l=JSON.parse(s),d=!1;for(let i of l)i.path===n&&(i.isFavorite=o,d=!0);d&&localStorage.setItem(r,JSON.stringify(l))}}catch(r){console.warn("\u274C Kh\xF4ng th\u1EC3 update recentViewed:",r)}}function J({title:e,folders:t,showViews:n=!1,targetId:o,onRefresh:c=null}){let a=document.createElement("section");a.className="folder-section slider";let r=document.createElement("div");r.className="folder-section-header";let s=document.createElement("div");s.className="slider-left";let l=document.createElement("h3");l.className="folder-section-title",l.textContent=e,s.appendChild(l),r.appendChild(s);let d=e.toLowerCase().includes("v\u1EEBa xem")||e.toLowerCase().includes("v\u1EEBa nghe")||e.toLowerCase().includes("m\u1EDBi \u0111\u1ECDc")||e.toLowerCase().includes("nh\u1EA1c v\u1EEBa nghe");if(e.includes("ng\u1EABu nhi\xEAn")||d){let u=document.createElement("div");if(u.className="slider-right",e.includes("ng\u1EABu nhi\xEAn")){let p=document.createElement("button");p.id="refresh-random-btn",p.textContent="\u{1F504} Refresh",p.className="small-button",u.appendChild(p),p.onclick=()=>{typeof c=="function"&&c()};let w=document.createElement("span");w.className="random-timestamp",e.includes("Folder")?w.id="random-timestamp-folder":e.includes("Video")?w.id="random-timestamp-video":e.includes("B\xE0i h\xE1t")?w.id="random-timestamp-audio":w.id="random-timestamp",w.textContent="",u.appendChild(w)}if(d){let p=document.createElement("button");p.textContent="\u{1F5D1}\uFE0F Xo\xE1 t\u1EA5t c\u1EA3",p.className="small-button",p.onclick=()=>{let w,$;window.location.pathname.includes("movie")?(w=ue(),$=A):window.location.pathname.includes("music")?(w=ne(),$=window.renderRecentViewedMusic||A):(w=me(),$=A),localStorage.removeItem(w),$([])},u.appendChild(p)}r.appendChild(u)}a.appendChild(r);let i=document.createElement("div");i.style.position="relative";let m=document.createElement("div");m.className="slider-wrapper",m.style.scrollSnapType="x mandatory",m.style.overflowX="auto";let v=window.location.pathname.includes("movie");t.forEach(u=>{let p=window.location.pathname.includes("music"),w=window.location.pathname.includes("movie"),$=!p&&!w,Q="movie";p?Q="music":$&&(Q="manga");let Ie=L(u,Q),$e={...u,thumbnail:Ie},G=te($e,n);G.style.scrollSnapAlign="start",m.appendChild(G);let K=encodeURIComponent(u.path),Y=g();G.onclick=Le=>{if(Le.target.classList.contains("folder-fav"))return;if(u.isPlaylist){let ee=g();window.location.href=`/music/player.html?playlist=${encodeURIComponent(u.path)}&key=${ee}`;return}let Z=window.location.pathname.includes("music"),de=window.location.pathname.includes("movie");if(Z&&(u.type==="audio"||u.type==="file")||de&&(u.type==="video"||u.type==="file")){let ee=Z?"music/player":"movie/player";window.location.href=`/${ee}.html?file=${K}&key=${Y}`;return}Z?window.location.href=`/music/index.html?path=${K}&key=${Y}`:de?window.location.href=`/movie/index.html?path=${K}&key=${Y}`:u.isSelfReader&&u.images?window.location.href=`/manga/reader.html?path=${K}`:typeof window.loadFolder=="function"&&window.loadFolder(u.path)}}),i.appendChild(m);let k=window.innerWidth<=768,C=document.createElement("button"),R=document.createElement("button");C.className="nav-button prev-button",R.className="nav-button next-button",C.innerHTML="\u2190",R.innerHTML="\u2192",k||(i.appendChild(C),i.appendChild(R)),a.appendChild(i);let j=document.createElement("div");j.className="slider-pagination",a.appendChild(j);let z=o?document.getElementById(o):document.getElementById(e.includes("ng\u1EABu nhi\xEAn")?"section-random":e.includes("Xem nhi\u1EC1u")?"section-topview":"section-recent");z&&(z.innerHTML="",z.appendChild(a));let H=m.querySelector(".folder-card")?.offsetWidth+16||200,re=Math.ceil(t.length/5);C.onclick=()=>m.scrollBy({left:-H,behavior:"smooth"}),R.onclick=()=>m.scrollBy({left:H,behavior:"smooth"});for(let u=0;u<re;u++){let p=document.createElement("span");p.className="pagination-dot",p.style.cursor="pointer",u===0&&p.classList.add("active"),p.onclick=()=>m.scrollTo({left:u*H*5,behavior:"smooth"}),j.appendChild(p)}m.addEventListener("scroll",()=>{let u=m.scrollLeft/(m.scrollWidth-m.clientWidth),p=Math.round(u*(re-1));j.querySelectorAll(".pagination-dot").forEach((w,$)=>{w.classList.toggle("active",$===p)})});let U=0,P=null,Ee=()=>{let u=m.scrollWidth-m.clientWidth;U+=H*5,U>u&&(U=0),m.scrollTo({left:U,behavior:"smooth"})},se=()=>{!k&&!P&&(P=setInterval(Ee,2e4))},le=()=>{P&&clearInterval(P),P=null};new IntersectionObserver(u=>{u[0].isIntersecting?se():le()},{threshold:.5}).observe(a),m.addEventListener("mouseenter",le),m.addEventListener("mouseleave",se)}async function Be(){let e=document.getElementById("floatingSearchInput")?.value.trim().toLowerCase(),t=document.getElementById("search-dropdown"),n=B(),o=g();if(!e){t.classList.add("hidden"),t.innerHTML="";return}t.classList.remove("hidden"),t.innerHTML='<div id="search-loader">\u{1F50D} \u0110ang t\xECm ki\u1EBFm...</div>';try{let a=await(await fetch(`/api/manga/folder-cache?mode=search&key=${encodeURIComponent(o)}&root=${encodeURIComponent(n)}&q=${encodeURIComponent(e)}`)).json();if(t.innerHTML="",a.length===0){t.innerHTML='<div id="search-loader">\u274C Kh\xF4ng t\xECm th\u1EA5y k\u1EBFt qu\u1EA3</div>';return}a.forEach(r=>{let s=document.createElement("div");s.className="search-item",s.innerHTML=`
        <img src="${r.thumbnail}" class="search-thumb" alt="thumb">
        <div class="search-title">${r.name}</div>
      `,s.onclick=()=>{t.classList.add("hidden"),window.location.pathname.includes("reader.html")?window.location.href=`/manga/index.html?path=${encodeURIComponent(r.path)}`:window.loadFolder?.(r.path)},t.appendChild(s)})}catch(c){t.innerHTML='<div id="search-loader">\u26A0\uFE0F L\u1ED7i khi t\xECm ki\u1EBFm</div>',console.error("\u274C L\u1ED7i t\xECm ki\u1EBFm:",c)}}function he(){let e=document.getElementById("floating-search");e?.classList.toggle("active");let t=document.getElementById("floatingSearchInput");e?.classList.contains("active")?t?.focus():(t.value="",Be())}function A(e=[]){let t=window.location.pathname.includes("movie"),n=t?e.filter(o=>o.type==="video"||o.type==="file"):e.filter(o=>!o.type||o.type!=="video"&&o.type!=="file");J({title:t?"\u{1F553} V\u1EEBa xem":"\u{1F558} M\u1EDBi \u0111\u1ECDc",folders:n,targetId:"section-recent"})}function O(e,t){let n=document.createElement("button");return n.textContent=e,n.onclick=t,n}function V(e){return async(...t)=>{let n=document.getElementById("loading-overlay");n?.classList.remove("hidden"),await new Promise(o=>requestAnimationFrame(()=>setTimeout(o,0)));try{await e(...t)}catch(o){console.error("\u274C withLoading error:",o)}finally{n?.classList.add("hidden")}}}function h(e){let t=document.getElementById("global-toast");t||(t=document.createElement("div"),t.id="global-toast",t.style.position="fixed",t.style.bottom="20px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.background="#333",t.style.color="white",t.style.padding="10px 20px",t.style.borderRadius="8px",t.style.zIndex="9999",t.style.fontSize="14px",document.body.appendChild(t)),t.textContent=e,t.style.display="block",setTimeout(()=>{t.style.display="none"},3e3)}function M(e,t={}){let n=document.getElementById("global-confirm");return n||(n=document.createElement("div"),n.id="global-confirm",n.className="modal-overlay hidden",n.innerHTML=`
      <div class="modal-box">
        <p id="confirm-text"></p>
        <div class="buttons">
          <button class="ok">OK</button>
          <button class="cancel">Hu\u1EF7</button>
        </div>
      </div>
    `,document.body.appendChild(n)),n.querySelector("#confirm-text").textContent=e,n.classList.remove("hidden"),new Promise(o=>{let c=n.querySelector("button.ok"),a=n.querySelector("button.cancel"),r=()=>{n.classList.add("hidden"),c.removeEventListener("click",s),a.removeEventListener("click",l)},s=()=>{r(),t.loading&&document.getElementById("loading-overlay")?.classList.remove("hidden"),o(!0)},l=()=>{r(),o(!1)};c.addEventListener("click",s),a.addEventListener("click",l)})}function pe(){let e=document.getElementById("sidebar-menu");if(!e)return;e.innerHTML="";let t=g();e.appendChild(O("\u{1F3BC} \u0110\u1ED5i Music Folder",()=>{localStorage.removeItem("rootFolder"),window.location.href="/home.html"})),e.appendChild(O("\u{1F5D1} Xo\xE1 Music DB",V(async()=>{if(await M("B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n xo\xE1 DB music?",{loading:!0}))try{let c=await(await fetch(`/api/music/reset-cache-music?key=${t}&mode=delete`,{method:"DELETE"})).json();h(c.message||"\u2705 \u0110\xE3 xo\xE1 DB")}catch{h("\u274C L\u1ED7i khi g\u1ECDi API xo\xE1 DB")}}))),e.appendChild(O("\u{1F504} Reset DB (Xo\xE1 + Scan)",V(async()=>{if(await M("Reset DB music v\xE0 scan l\u1EA1i?",{}))try{let c=await(await fetch(`/api/music/reset-cache-music?key=${t}&mode=reset`,{method:"DELETE"})).json();h(c.message||"\u2705 Reset DB xong"),window.location.reload()}catch(o){console.error(o),h("\u274C L\u1ED7i reset DB")}}))),e.appendChild(O("\u{1F4E6} Qu\xE9t th\u01B0 m\u1EE5c m\u1EDBi",V(async()=>{if(await M("Qu\xE9t folder m\u1EDBi (kh\xF4ng xo\xE1 DB)?",{}))try{let c=await(await fetch("/api/music/scan-music",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:t})})).json();h(`\u2705 Scan xong:
Inserted ${c.stats.inserted}, Updated ${c.stats.updated}, Skipped ${c.stats.skipped}`)}catch{h("\u274C L\u1ED7i khi qu\xE9t folder")}}))),e.appendChild(O("\u{1F9FC} Xo\xE1 cache folder",V(async()=>{if(!await M("Xo\xE1 to\xE0n b\u1ED9 cache folder music?"))return;let o=0;Object.keys(localStorage).forEach(c=>{c.startsWith(`musicCache::${t}::`)&&(localStorage.removeItem(c),o++)}),h(`\u2705 \u0110\xE3 xo\xE1 ${o} cache folder`)})))}async function fe(){let e=document.getElementById("floatingSearchInput")?.value.trim().toLowerCase(),t=document.getElementById("search-dropdown"),n=g(),o=document.getElementById("search-type-select")?.value||"audio";if(!e){t.classList.add("hidden"),t.innerHTML="";return}t.classList.remove("hidden"),t.innerHTML='<div id="search-loader">\u{1F50D} \u0110ang t\xECm nh\u1EA1c...</div>';try{let a=await(await fetch(`/api/music/audio-cache?mode=search&key=${encodeURIComponent(n)}&q=${encodeURIComponent(e)}&type=${encodeURIComponent(o)}`)).json();if(t.innerHTML="",!a.folders||a.folders.length===0){t.innerHTML='<div id="search-loader">\u274C Kh\xF4ng t\xECm th\u1EA5y b\xE0i h\xE1t n\xE0o</div>';return}a.folders.forEach(r=>{let s=document.createElement("div");s.className="search-item";let l=r.type==="audio"||r.type==="file",d=L(r,"music");s.innerHTML=`
        <img src="${d}" class="search-thumb" alt="thumb">
        <div class="search-title">${r.name}</div>
      `,s.onclick=()=>{t.classList.add("hidden"),l?window.location.href=`/music/player.html?file=${encodeURIComponent(r.path)}`:window.location.href=`/music/index.html?path=${encodeURIComponent(r.path)}`},t.appendChild(s)})}catch(c){console.error("\u274C L\u1ED7i t\xECm ki\u1EBFm nh\u1EA1c:",c),t.innerHTML='<div id="search-loader">\u26A0\uFE0F L\u1ED7i khi t\xECm ki\u1EBFm</div>'}}function ye(e,t="",n="OK",o="H\u1EE7y"){return new Promise(c=>{let a=document.createElement("div");a.className="popup-overlay",a.style.zIndex="99999",a.innerHTML=`
      <div class="popup-confirm">
        <div class="popup-message">${e}</div>
        <input class="popup-input" type="text" placeholder="${t}" autofocus />
        <div class="popup-actions">
          <button class="popup-ok">${n}</button>
          <button class="popup-cancel">${o}</button>
        </div>
      </div>
    `,document.body.appendChild(a);let r=a.querySelector(".popup-input"),s=a.querySelector(".popup-ok"),l=a.querySelector(".popup-cancel");s.onclick=()=>{let d=r.value.trim();a.remove(),c(d||null)},l.onclick=()=>{a.remove(),c(null)},r.onkeydown=d=>{d.key==="Enter"&&s.click(),d.key==="Escape"&&l.click()},r.focus()})}function L(e,t="movie"){let n="/video/",o="/default/video-thumb.png",c="/default/folder-thumb.png";t==="music"?(n="/audio/",o="/default/music-thumb.png",c="/default/folder-thumb.png"):(t==="manga"||t==="comic")&&(n="/manga/",o="/default/manga-thumb.png",c="/default/folder-thumb.png");let a;return e.type==="folder"?a=e.path||"":a=e.path?.split("/").slice(0,-1).join("/")||"",e.thumbnail?e.thumbnail.startsWith(n)||e.thumbnail.startsWith("http")||e.thumbnail.startsWith("/default/")?e.thumbnail:(a&&e.thumbnail.startsWith(a+"/")&&(e.thumbnail=e.thumbnail.slice(a.length+1)),`${n}${a?a+"/":""}${e.thumbnail.replace(/\\/g,"/")}`):t==="music"?e.type==="audio"||e.type==="file"?o:c:t==="manga"||t==="comic"?e.type==="folder"?c:o:e.type==="video"||e.type==="file"?o:c}function B(){return localStorage.getItem("rootFolder")}function g(){return localStorage.getItem("sourceKey")}function me(){return`recentViewed::${B()}::${B()}`}function ue(){return`recentViewedVideo::${g()}`}function ne(){return`recentViewedMusic::${g()}`}function ge(e){let t=ne();try{let n=localStorage.getItem(t),c=(n?JSON.parse(n):[]).filter(r=>r.path!==e.path);c.unshift({name:e.name,path:e.path,thumbnail:e.thumbnail,type:"audio",artist:e.artist});let a=c.slice(0,30);localStorage.setItem(t,JSON.stringify(a))}catch(n){console.warn("\u274C Kh\xF4ng th\u1EC3 l\u01B0u recentViewedMusic:",n)}}async function D(e,t,n){let o=document.getElementById("playlist-popup");o||(o=document.createElement("div"),o.id="playlist-popup",o.className="playlist-popup",document.body.appendChild(o));let c=g(),a=[];try{a=await(await fetch(`/api/music/playlists?key=${c}`)).json()}catch{h("\u274C L\u1ED7i t\u1EA3i danh s\xE1ch playlist")}o.innerHTML=`
  <div class="popup-title" style="display:flex;align-items:center;justify-content:space-between;gap:4px;">
    <span class="popup-title-text" title="${t}" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:215px;display:inline-block;">
      Add "${t}"
    </span>
    <button id="playlist-close-btn" title="\u0110\xF3ng" style="
      background:none;
      border:none;
      font-size:1.3em;
      line-height:1;
      cursor:pointer;
      color:#999;
      margin-left:10px;
      padding:0 6px 0 6px;
      flex-shrink:0;
      ">\u2716</button>
  </div>
  <div class="playlist-list-scroll"></div>
`,document.getElementById("playlist-close-btn")?.addEventListener("click",()=>{o.remove()});let r=o.querySelector(".playlist-list-scroll");(await Promise.all(a.map(async i=>{let k=(await(await fetch(`/api/music/playlist/${i.id}?key=${c}`)).json()).tracks?.some(C=>C.path===e);return{...i,contains:k}}))).forEach(i=>{let m=document.createElement("div");m.className="playlist-row";let v=document.createElement("button");v.className="playlist-option"+(i.contains?" bold":""),v.innerHTML=i.contains?`\u2705 ${i.name}`:i.name,v.style.flex="1",v.style.textAlign="left",v.onclick=async()=>{i.contains?(await fetch("/api/music/playlist/remove",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:c,playlistId:i.id,path:e})}),h("\u274C \u0110\xE3 xo\xE1 kh\u1ECFi playlist")):(await fetch("/api/music/playlist/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:c,playlistId:i.id,path:e})}),h("\u2705 \u0110\xE3 th\xEAm v\xE0o playlist")),D(e,t,n)};let k=document.createElement("button");k.textContent="\u{1F5D1}\uFE0F",k.className="playlist-delete-btn",k.title="Xo\xE1 playlist n\xE0y",k.style.marginLeft="6px",k.onclick=async C=>{C.stopPropagation(),await M(`Xo\xE1 playlist "${i.name}"?`)&&(await fetch("/api/music/playlist",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:c,id:i.id})}),h("\u{1F5D1}\uFE0F \u0110\xE3 xo\xE1 playlist"),D(e,t,n))},m.appendChild(v),m.appendChild(k),m.style.display="flex",m.style.alignItems="center",m.style.gap="0",r.appendChild(m)});let l=document.createElement("button");l.className="playlist-option bold playlist-add-btn",l.textContent="\u2795 T\u1EA1o playlist m\u1EDBi...",l.onclick=async()=>{let i=await ye("Nh\u1EADp t\xEAn playlist m\u1EDBi","T\xEAn playlist");if(!i)return;(await(await fetch("/api/music/playlist",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:c,name:i})})).json())?.id&&(h("\u2705 T\u1EA1o playlist th\xE0nh c\xF4ng!"),D(e,t,n))},o.appendChild(l);let d=window.innerWidth<=480;o.style.position="fixed",o.style.left="50%",o.style.top="50%",o.style.transform="translate(-50%, -50%)",o.style.width=d?"min(96vw, 400px)":"340px",o.style.maxWidth=d?"96vw":"340px",o.style.maxHeight=d?"87vh":"70vh",setTimeout(()=>{function i(m){o.contains(m.target)||(o.remove(),document.removeEventListener("click",i))}document.addEventListener("click",i)},0)}function Me(e){let t=document.getElementById("now-playing-info");if(!t)return;if(!e){t.innerHTML="";return}let n=L(e,"music");t.innerHTML=`
    <div class="now-playing-cover">
      <img class="now-playing-thumb" src="${n}" alt="thumb" />
      <div class="now-playing-meta">
        <div class="now-title">
          ${e.name}
          <button id="btn-add-playlist" title="Th\xEAm v\xE0o playlist" style="margin-left:8px;">+</button>
          <button id="btn-add-thumb" title="D\xF9ng thumbnail n\xE0y" style="margin-left:6px;">\u{1F5BC}\uFE0F</button>
        </div>
        <div class="now-artist">${e.artist||"Unknown Artist"}</div>
        <div class="now-extra">
          <span>\u{1F441}\uFE0F ${e.viewCount||0}</span>
          <span>${e.album?"\u2022 "+e.album:""}</span>
        </div>
      </div>
    </div>
  `,document.getElementById("btn-add-playlist")?.addEventListener("click",o=>{o.stopPropagation(),D(e.path,e.name,o.target)}),document.getElementById("btn-add-thumb")?.addEventListener("click",async o=>{o.stopPropagation();try{await fetch("/api/music/extract-thumbnail",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:T,path:e.path})}),F?(await fetch("/api/music/playlist-thumbnail",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:T,playlistId:F,srcPath:e.path})}),h("\u2705 \u0110\xE3 \u0111\u1EB7t thumbnail cho playlist"),xe()):(await fetch("/api/music/folder-thumbnail",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:T,folderPath:N,srcPath:e.path})}),h("\u2705 \u0110\xE3 \u0111\u1EB7t thumbnail cho th\u01B0 m\u1EE5c"))}catch{h("\u274C L\u1ED7i \u0111\u1EB7t thumbnail")}})}pe();document.getElementById("searchToggle")?.addEventListener("click",he);document.getElementById("floatingSearchInput")?.addEventListener("input",fe);document.getElementById("sidebarToggle")?.addEventListener("click",()=>{document.getElementById("sidebar-menu")?.classList.toggle("active")});var ae=new URLSearchParams(window.location.search),q=ae.get("file"),F=ae.get("playlist"),T=ae.get("key")||g();if(!T)throw h("\u274C Thi\u1EBFu sourceKey"),new Error("Missing sourceKey");if(!q&&!F)throw h("\u274C Thi\u1EBFu file ho\u1EB7c playlist"),new Error("Missing file or playlistId");var b=document.getElementById("audio-player"),Ne=document.getElementById("now-playing"),x=document.getElementById("folder-title"),be=document.getElementById("folder-track-count"),oe=[],N="",Fe="";q&&(oe=q.split("/").filter(Boolean),N=oe.slice(0,-1).join("/"),Fe=oe.at(-1));function Re(){if(!F)if(N){let e=N.split("/").pop()||"Root";x.textContent=`\u{1F4C1} ${e}`,x.classList.add("clickable"),x.title="Quay l\u1EA1i th\u01B0 m\u1EE5c n\xE0y",x.onclick=()=>{window.location.href=`/music/index.html?path=${encodeURIComponent(N)}`}}else x.textContent="\u{1F4C1} Playlist",x.classList.remove("clickable"),x.onclick=null}var y=[],f=-1;async function Pe(){try{y=((await(await fetch(`/api/music/music-folder?key=${T}&path=${encodeURIComponent(N)}`)).json()).folders||[]).filter(n=>n.type==="audio"||n.type==="file"),f=y.findIndex(n=>n.path===q),ke(),Re(),f>=0?E(f):h("\u274C Kh\xF4ng t\xECm th\u1EA5y b\xE0i hi\u1EC7n t\u1EA1i")}catch(e){console.error("\u274C L\u1ED7i khi load th\u01B0 m\u1EE5c:",e),h("L\u1ED7i khi t\u1EA3i danh s\xE1ch b\xE0i h\xE1t")}}async function Oe(e){try{let n=await(await fetch(`/api/music/playlist/${e}?key=${T}`)).json();y=(n.tracks||[]).filter(o=>o.type==="audio"||o.type==="file"),f=0,ke(),x.textContent=`\u{1F3B5} ${n.name||"Playlist"}`,x.classList.add("playlist-title"),x.classList.remove("clickable"),x.onclick=null,be.textContent=`${y.length} tracks`,E(f)}catch(t){h("\u274C Kh\xF4ng th\u1EC3 load playlist"),console.error(t)}}function ke(){let e=document.getElementById("track-body");e.innerHTML="",y.forEach((t,n)=>{let o=document.createElement("tr"),c;I&&S.length===y.length?c=S[f]:c=f,o.className=n===c?"playing":"";let a=L(t,"music"),r=document.createElement("td");r.innerHTML=`
  <div class="track-flex">
    <img class="track-thumb" src="${a}" alt="thumb" />
    <div class="track-info">
      <div class="track-title">${t.name}</div>
      <div class="track-artist">${t.artist||"Unknown"}</div>
    </div>
  </div>
`;let s=document.createElement("td");s.textContent=t.album||"Unknown";let l=t.path?.split("/").filter(Boolean),d=l.length>1?l.slice(0,-1).join("/"):"",i=document.createElement("td");i.textContent=d||"Root",i.classList.add("clickable-folder"),d&&(i.style.color="#1db954",i.style.cursor="pointer",i.title="Click \u0111\u1EC3 m\u1EDF th\u01B0 m\u1EE5c",i.onclick=C=>{C.stopPropagation(),window.location.href=`/music/index.html?path=${encodeURIComponent(d)}`});let m=document.createElement("td");m.textContent=t.viewCount||0;let v=document.createElement("td");v.textContent=X(t.duration),v.className="track-duration";let k=n;I&&S.length===y.length&&(k=S.findIndex(C=>C===n)),o.onclick=()=>E(k),o.append(r,s,i,m,v),e.appendChild(o)}),be.textContent=`${y.length} tracks`}function E(e){if(!y.length)return;let t=I?S[e]:e;t===void 0&&(t=e),f=e;let n=y[t],o=`/api/music/audio?key=${T}&file=${encodeURIComponent(n.path)}`;b.src=o,b.play().catch(()=>{h("\u26A0\uFE0F Kh\xF4ng th\u1EC3 ph\xE1t b\xE0i h\xE1t")}),Ne.textContent=`\u{1F3B5} ${n.name}`,Me(n),Se(),ce(),fetch("/api/increase-view/music",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:T,path:n.path})}).catch(()=>{}),console.log(n),ge({name:n.name,path:n.path,thumbnail:n.thumbnail,type:"audio",artist:n.artist||"",album:n.album||""})}function Se(){let e;I&&S.length===y.length?e=S[f]:e=f,document.querySelectorAll("#track-body tr").forEach((t,n)=>{t.classList.toggle("playing",n===e)})}var W=!1,I=!1,S=[],ve=document.getElementById("btn-repeat"),_=document.getElementById("seekbar"),Ce=document.getElementById("current-time"),De=document.getElementById("duration"),we=document.getElementById("btn-shuffle"),ie=document.getElementById("btn-play");ve.onclick=()=>{W=!W,ve.classList.toggle("active",W)};function je(e){let t=e.slice();for(let n=t.length-1;n>0;n--){let o=Math.floor(Math.random()*(n+1));[t[n],t[o]]=[t[o],t[n]]}return t}function ce(){_.max=b.duration||1,_.value=b.currentTime||0,Ce.textContent=X(b.currentTime),De.textContent=X(b.duration)}b.addEventListener("timeupdate",ce);b.addEventListener("loadedmetadata",ce);_.addEventListener("input",()=>{b.currentTime=_.value,Ce.textContent=X(b.currentTime)});b.addEventListener("play",()=>{ie.textContent="\u23F8"});b.addEventListener("pause",()=>{ie.textContent="\u25B6\uFE0F"});we.onclick=()=>{if(I=!I,we.classList.toggle("active",I),I){let e=I&&S.length===y.length?S[f]:f;S=[e].concat(je([...Array(y.length).keys()].filter(t=>t!==e))),f=0}else S.length===y.length&&(f=S[f]),S=[];Se()};document.getElementById("btn-prev").onclick=()=>{y.length&&(f>0?E(f-1):E(y.length-1))};document.getElementById("btn-next").onclick=()=>{y.length&&(f+1<y.length?E(f+1):E(0))};ie.onclick=()=>{b.paused?b.play():b.pause()};b.addEventListener("ended",()=>{W?E(f):f+1<y.length?E(f+1):E(0)});function X(e){if(!e||isNaN(e))return"--:--";let t=Math.floor(e/60),n=Math.floor(e%60);return`${t}:${n.toString().padStart(2,"0")}`}F?Oe(F):Pe();xe();async function xe(){let e=g();if(!e)return;let t=document.getElementById("section-playlists");if(t){t.innerHTML="<p>\u23F3 \u0110ang t\u1EA3i playlist...</p>";try{let o=await(await fetch(`/api/music/playlists?key=${e}`)).json();if(!Array.isArray(o)||o.length===0){t.innerHTML="<p>\u{1F605} Ch\u01B0a c\xF3 playlist n\xE0o</p>";return}let c=await Promise.all(o.map(async a=>{if(a.thumbnail)return{...a,path:a.id.toString(),thumbnail:L({thumbnail:a.thumbnail,path:""},"music"),isPlaylist:!0,type:"folder"};try{let l=(await(await fetch(`/api/music/playlist/${a.id}?key=${e}`)).json()).tracks?.[0],d=l?L(l,"music"):"/default/folder-thumb.png";return{...a,path:a.id.toString(),thumbnail:d,isPlaylist:!0,type:"folder"}}catch{return{...a,path:a.id.toString(),thumbnail:"/default/folder-thumb.png",isPlaylist:!0,type:"folder"}}}));J({title:"\u{1F3B6} Playlist",folders:c,targetId:"section-playlists"})}catch(n){console.error("loadPlaylistSlider error",n),t.innerHTML="<p>\u274C L\u1ED7i t\u1EA3i playlist</p>"}}}})();
