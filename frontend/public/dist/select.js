(()=>{var w="folderCache::",u="rootThumb::";function s(){return localStorage.getItem("sourceKey")}function p(){s()||(c("\u26A0\uFE0F Ch\u01B0a ch\u1ECDn ngu\u1ED3n d\u1EEF li\u1EC7u, vui l\xF2ng ch\u1ECDn l\u1EA1i!"),window.location.href="/home.html")}function f(t,e){let o=`${u}${t}::${e}`,n=localStorage.getItem(o);if(!n)return null;try{let{thumbnail:a,time:r}=JSON.parse(n);return Date.now()-r>7*24*60*60*1e3?(localStorage.removeItem(o),null):a}catch{return localStorage.removeItem(o),null}}function g(t,e,o){let n=`${u}${t}::${e}`,a={thumbnail:o,time:Date.now()};localStorage.setItem(n,JSON.stringify(a))}function C(t,e,o){if(!t)return null;let n=`${w}${t}`;return e&&(n+=`::${e}`),o&&(n+=`:${o}`),n}function y(){Object.keys(localStorage).forEach(t=>{t.startsWith(C(s()))&&localStorage.removeItem(t)})}function m(t){return async(...e)=>{let o=document.getElementById("loading-overlay");o?.classList.remove("hidden"),await new Promise(n=>requestAnimationFrame(()=>setTimeout(n,0)));try{await t(...e)}catch(n){console.error("\u274C withLoading error:",n)}finally{o?.classList.add("hidden")}}}function c(t){let e=document.getElementById("global-toast");e||(e=document.createElement("div"),e.id="global-toast",e.style.position="fixed",e.style.bottom="20px",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.background="#333",e.style.color="white",e.style.padding="10px 20px",e.style.borderRadius="8px",e.style.zIndex="9999",e.style.fontSize="14px",document.body.appendChild(e)),e.textContent=t,e.style.display="block",setTimeout(()=>{e.style.display="none"},3e3)}function h(t,e={}){let o=document.getElementById("global-confirm");return o||(o=document.createElement("div"),o.id="global-confirm",o.className="modal-overlay hidden",o.innerHTML=`
      <div class="modal-box">
        <p id="confirm-text"></p>
        <div class="buttons">
          <button class="ok">OK</button>
          <button class="cancel">Hu\u1EF7</button>
        </div>
      </div>
    `,document.body.appendChild(o)),o.querySelector("#confirm-text").textContent=t,o.classList.remove("hidden"),new Promise(n=>{let a=o.querySelector("button.ok"),r=o.querySelector("button.cancel"),d=()=>{o.classList.add("hidden"),a.removeEventListener("click",i),r.removeEventListener("click",l)},i=()=>{d(),e.loading&&document.getElementById("loading-overlay")?.classList.remove("hidden"),n(!0)},l=()=>{d(),n(!1)};a.addEventListener("click",i),r.addEventListener("click",l)})}function k(t){let e=s();p();let o=document.createElement("div");o.className="music-card";let n=document.createElement("img");n.className="music-thumb",n.src="/default/default-cover.jpg",n.alt=t,n.loading="lazy";let a=f(e,t);a?n.src=`/manga/${encodeURIComponent(t)}/${a.replace(/\\/g,"/")}`:fetch(`/api/manga/root-thumbnail?key=${encodeURIComponent(e)}&root=${encodeURIComponent(t)}`).then(i=>i.json()).then(i=>{if(i.thumbnail){let l=i.thumbnail.replace(/\\/g,"/");n.src=`/manga/${encodeURIComponent(t)}/${l}`,g(e,t,i.thumbnail)}}).catch(i=>console.error("load thumbnail",i));let r=document.createElement("div");r.className="music-info";let d=document.createElement("div");return d.className="music-title",d.textContent=t,r.appendChild(d),o.appendChild(n),o.appendChild(r),o.onclick=m(async()=>{localStorage.setItem("rootFolder",t);let l=await(await fetch(`/api/manga/folder-cache?mode=folders&key=${encodeURIComponent(e)}&root=${encodeURIComponent(t)}`)).json();Array.isArray(l)&&l.length===0&&(console.log("\u{1F4C2} DB r\u1ED7ng, ti\u1EBFn h\xE0nh scan..."),await m(async()=>{await fetch("/api/manga/scan",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({root:t,key:e})})})(),alert("\u2705 \u0110\xE3 qu\xE9t cache cho root folder.")),window.location.href="/manga/index.html"}),o}async function b(){let t=localStorage.getItem("sourceKey");if(!t)return c("\u274C Ch\u01B0a ch\u1ECDn ngu\u1ED3n manga!"),window.location.href="/home.html";if(!t.startsWith("ROOT_"))return c("\u26A0\uFE0F Ngu\u1ED3n hi\u1EC7n t\u1EA1i kh\xF4ng ph\u1EA3i manga!"),window.location.href="/home.html";try{let e=await fetch(`/api/list-roots?key=${encodeURIComponent(t)}`);if(!e.ok){let a=await e.text();throw new Error(`Server ${e.status}: ${a}`)}let o=await e.json(),n=document.getElementById("folder-list");n.innerHTML="",o.forEach(a=>{let r=k(a);n.appendChild(r)})}catch(e){console.error("\u274C L\u1ED7i load root folders:",e)}}document.getElementById("reset-all-db-btn")?.addEventListener("click",async()=>{if(await h("B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n xo\xE1 to\xE0n b\u1ED9 DB kh\xF4ng?",{loading:!0}))try{let e=s();if(!e)return c("\u274C Thi\u1EBFu sourceKey");let n=await(await fetch(`/api/manga/reset-cache/all?key=${encodeURIComponent(e)}`,{method:"DELETE"})).json();c(n.message||"\u2705 \u0110\xE3 xo\xE1 to\xE0n b\u1ED9 DB th\xE0nh c\xF4ng!")}catch(e){c("\u274C L\u1ED7i khi xo\xE1 DB"),console.error("\u274C reset-all-db:",e)}finally{document.getElementById("loading-overlay")?.classList.add("hidden")}});document.getElementById("clear-all-folder-cache-btn")?.addEventListener("click",async()=>{if(!await h("B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n xo\xE1 to\xE0n b\u1ED9 folder cache localStorage?"))return;if(!s())return c("\u274C Thi\u1EBFu sourceKey");y(),c("\u{1F9FC} \u0110\xE3 xo\xE1 to\xE0n b\u1ED9 folder cache"),location.reload()});window.addEventListener("DOMContentLoaded",b);})();
